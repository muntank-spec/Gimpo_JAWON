<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#4facfe">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="icon.png">
    
    <title>ê¹€í¬ì‹œ ìì›í™”ì„¼í„°</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Jua&display=swap');

        body {
            margin: 0; padding: 0; overflow: hidden;
            background: linear-gradient(180deg, #4facfe 0%, #00f2fe 100%);
            font-family: 'Jua', sans-serif;
            user-select: none; -webkit-user-select: none;
            color: #333; touch-action: none;
        }

        /* ë°°ê²½ ì• ë‹ˆë©”ì´ì…˜ */
        #background-shapes { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; pointer-events: none; overflow: hidden; }
        .bg-icon { position: absolute; font-size: 50px; opacity: 0.25; animation: float 15s infinite linear; color: rgba(255, 255, 255, 0.8); }
        @keyframes float { 0% { transform: translateY(110vh) rotate(0deg); } 100% { transform: translateY(-10vh) rotate(360deg); } }

        .page {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: none; flex-direction: column; 
            align-items: center; justify-content: center; text-align: center;
            z-index: 100; overflow-y: auto; -webkit-overflow-scrolling: touch;
            box-sizing: border-box;
        }
        
        #main-menu { display: flex; padding-top: 20px; box-sizing: border-box; } 

        .main-logo { 
            font-size: 10vw; margin-bottom: 20px; color: #1e3799; 
            text-shadow: 2px 2px 0 #fff, -1px -1px 0 #fff, 1px -1px 0 #fff, -1px 1px 0 #fff, 1px 1px 0 #fff, 4px 4px 5px rgba(0,0,0,0.2);
            z-index: 10; letter-spacing: 2px; font-weight: 900; word-break: keep-all; line-height: 1.2;
        }
        #logoCanvas { margin-bottom: 10px; margin-top: 20px; filter: drop-shadow(0 5px 5px rgba(0,0,0,0.2)); }

        /* [ì‹ ê·œ] ì£¼ì œê°€ ë§í’ì„  ì• ë‹ˆë©”ì´ì…˜ ë²„íŠ¼ */
        .theme-song-bubble {
            position: absolute;
            top: -15px;
            right: -30px;
            background: #ff4757;
            color: white;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 16px;
            font-weight: bold;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            cursor: pointer;
            animation: bounce-bubble 1.5s infinite;
            border: 2px solid white;
            z-index: 20;
            white-space: nowrap;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
        }
        .theme-song-bubble::after {
            content: ''; position: absolute; bottom: -6px; left: 20px;
            border-width: 6px 6px 0; border-style: solid; border-color: #ff4757 transparent transparent transparent; display: block; width: 0;
        }
        @keyframes bounce-bubble {
            0%, 100% { transform: translateY(0) rotate(3deg); }
            50% { transform: translateY(-8px) rotate(-3deg); }
        }

        .white-panel {
            background: rgba(255, 255, 255, 0.95); border-radius: 20px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.15); color: #2c3e50; padding: 25px; 
            margin-top: 20px; text-align: left; border: 3px solid #fff; width: 85%; max-width: 600px;
        }

        .btn {
            border: none; padding: 15px 0; width: 85%; max-width: 400px;
            font-size: 24px; font-family: 'Jua', sans-serif; border-radius: 50px; cursor: pointer; margin: 10px 0;
            transition: all 0.1s; color: white; box-shadow: 0 5px 0 rgba(0,0,0,0.2); position: relative; overflow: hidden;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.3); pointer-events: auto; touch-action: manipulation;
        }
        .btn:active { transform: translateY(4px); box-shadow: none; }

        .btn-home { background: #ff9f43; position: absolute; top: 55px; right: 15px; z-index: 300; font-size: 18px; padding: 8px 20px; border: 2px solid white; width: auto; }
        .btn-bgm { background: rgba(0,0,0,0.2); position: absolute; top: 55px; left: 15px; z-index: 300; font-size: 14px; padding: 8px 15px; border: 1px solid white; color: white; border-radius: 20px; cursor: pointer; width: auto; margin: 0; }

        .btn-exit-game {
            position: absolute; top: 55px; left: 15px; z-index: 300;
            background: linear-gradient(135deg, #ff416c, #ff4b2b);
            color: white; border: 2px solid #fff; border-radius: 20px;
            padding: 8px 16px; font-size: 14px; font-family: 'Jua', sans-serif;
            cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            text-shadow: 1px 1px 2px rgba(0,0,0,0.3); transition: transform 0.1s;
        }
        .btn-exit-game:active { transform: scale(0.92); }

        .btn-hint {
            position: absolute; bottom: 20px; right: 20px; z-index: 300;
            background: rgba(255, 235, 59, 0.8); border: 2px solid #fbc02d;
            border-radius: 50%; width: 50px; height: 50px; font-size: 24px;
            display: flex; justify-content: center; align-items: center; cursor: pointer;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            display: none; 
        }

        .btn-game { background: linear-gradient(to bottom, #2ecc71, #27ae60); font-size: 32px; padding: 20px 0; }
        .btn-info { background: linear-gradient(to bottom, #3498db, #2980b9); }
        .btn-promo { background: linear-gradient(to bottom, #9b59b6, #8e44ad); }
        
        .btn-select-sort { background: white; color: #333; border: 3px solid #2ecc71; padding: 15px 20px; display:flex; align-items:center; justify-content: space-between; text-shadow: none; margin: 8px 0;}
        .btn-select-pipe { background: white; color: #333; border: 3px solid #e74c3c; padding: 15px 20px; display:flex; align-items:center; justify-content: space-between; text-shadow: none; margin: 8px 0;}
        .btn-select-shooter { background: white; color: #333; border: 3px solid #9b59b6; padding: 15px 20px; display:flex; align-items:center; justify-content: space-between; text-shadow: none; margin: 8px 0;}
        .btn-select-sichuan { background: white; color: #333; border: 3px solid #f39c12; padding: 15px 20px; display:flex; align-items:center; justify-content: space-between; text-shadow: none; margin: 8px 0;}

        .top-counter {
            background: rgba(255, 255, 255, 0.9); padding: 8px 20px; border-radius: 30px;
            color: #1e3799; font-size: 16px; font-weight: bold; box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            margin-bottom: 10px; display: inline-block;
        }

        .content-box { font-size: 18px; line-height: 1.6; }
        .content-title { font-size: 32px; color: #1e3799; margin-bottom: 15px; font-weight: bold; text-shadow: 2px 2px 0px #fff; }
        
        #gameCanvas { display: block; position: absolute; top: 0; left: 0; z-index: 50; touch-action: none; }
        
        #game-ui-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.85); z-index: 150;
            display: none; flex-direction: column; justify-content: center; align-items: center; text-align: center; color: white; 
        }
        
        #score-board { 
            position: absolute; top: 55px; right: 15px; left: auto; transform: none;
            color: white; font-size: 14px; font-weight: bold; z-index: 60; 
            background: rgba(0,0,0,0.6); padding: 8px 15px; border-radius: 20px; border: 2px solid white; white-space: nowrap;
        }
        
        #rank-board { width: 100%; max-width: 400px; max-height: 200px; overflow-y: auto; margin: 10px 0; color: #2c3e50; }
        .rank-item { display: flex; justify-content: space-between; border-bottom: 1px solid #ddd; padding: 10px 0; font-size: 18px; }
        .rank-item:nth-child(1) { color: #e74c3c; font-weight: bold; } 
        
        .blink { animation: blinker 1.5s linear infinite; color: #fff; font-size: 24px; cursor: pointer; border: 3px solid #fff; padding: 15px 40px; border-radius: 50px; background: #e74c3c; box-shadow: 0 5px 15px rgba(0,0,0,0.3); margin-top: 15px;}
        @keyframes blinker { 50% { opacity: 0.8; transform: scale(0.98); } }

        /* ê°€ë¡œ ëª¨ë“œ ì°¨ë‹¨ */
        #orientation-warning {
            display: none;
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #2c3e50; z-index: 99999;
            flex-direction: column; justify-content: center; align-items: center;
            color: white; text-align: center;
        }

        @media only screen and (orientation: landscape) {
            #orientation-warning { display: flex !important; }
            .page, #gameCanvas, #background-shapes, #game-ui-layer { display: none !important; }
        }

        /* --- ì¹´íˆ° ê³µì • íë¦„ë„ìš© ìŠ¤íƒ€ì¼ --- */
        .process-step {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 15px;
            margin: 5px 0;
            width: 85%;
            max-width: 320px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.15);
            text-align: center;
            cursor: pointer;
            transition: transform 0.1s;
            border: 3px solid #fff;
        }
        .process-step:active { transform: scale(0.98); }
        .step-icon { font-size: 45px; margin-bottom: 5px; }
        .step-title { font-size: 20px; font-weight: bold; color: #2c3e50; letter-spacing: -0.5px;}
        
        /* ë§í’ì„  CSS */
        .speech-bubble {
            display: none;
            position: relative;
            background: #f8f9fa;
            color: #2c3e50;
            padding: 15px;
            border-radius: 15px;
            font-size: 15px;
            margin-top: 15px;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.05);
            text-align: left;
            line-height: 1.4;
            border: 2px solid #bdc3c7; 
            word-break: keep-all;
        }
        .speech-bubble::before {
            content: ""; position: absolute; bottom: 100%; left: 50%; margin-left: -10px;
            border-width: 10px; border-style: solid; border-color: transparent transparent #bdc3c7 transparent;
        }
        .speech-bubble::after {
            content: ""; position: absolute; bottom: 100%; left: 50%; margin-left: -7px;
            border-width: 7px; border-style: solid; border-color: transparent transparent #f8f9fa transparent;
        }
        .process-step.active .speech-bubble { display: block; animation: popDown 0.2s ease-out; }
        @keyframes popDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        
        .step-arrow { font-size: 24px; color: #fff; text-shadow: 1px 1px 2px rgba(0,0,0,0.3); margin: 3px 0; }
    </style>
</head>
<body>

    <div id="orientation-warning">
        <div style="font-size: 80px; margin-bottom: 20px;">ğŸ“²ğŸš«</div>
        <h2 style="margin: 0; font-size: 28px;">í•¸ë“œí°ì„ ì„¸ë¡œë¡œ<br>ëŒë ¤ì£¼ì„¸ìš”!</h2>
        <p style="font-size: 16px; color: #bdc3c7; margin-top: 15px;">ì´ ê²Œì„ì€ ì„¸ë¡œ ëª¨ë“œ ì „ìš©ì…ë‹ˆë‹¤.</p>
    </div>

    <div id="background-shapes"></div>

    <div id="main-menu" class="page">
        <button id="bgm-toggle" class="btn-bgm" onclick="Sound.toggleBGM()">ğŸ”‡ ì‚¬ìš´ë“œ: OFF</button>
        <button class="btn-home" style="opacity:0; pointer-events:none;">.</button>
        
        <div style="height: 80px;"></div>
        <div class="top-counter">ğŸŒ± í™˜ê²½ì— ë‹¤ê°€ê°„ íšŸìˆ˜: <span id="mainUserCount">0</span>íšŒ</div>
        
        <canvas id="logoCanvas" width="200" height="160"></canvas>
        
        <div style="position: relative;">
            <h1 class="main-logo" style="margin-bottom: 20px;">ê¹€í¬ì‹œ<br>ìì›í™”ì„¼í„°</h1>
            <div class="theme-song-bubble" onclick="Sound.click(); window.open('https://youtube.com/shorts/F0coCr8baLE?si=Uw08HIWJy2EaY-od', '_blank')">
                ğŸµ ì£¼ì œê°€
            </div>
        </div>
        
        <button class="btn btn-info" onclick="Sound.click(); goPage('notice')">ğŸ“¢ ì´ìš© ì•ˆë‚´ì‚¬í•­</button>
        <button class="btn btn-promo" onclick="Sound.click(); goPage('promo')">ğŸ¢ ì‹œì„¤ í™ë³´</button>
        <div style="height: 10px;"></div>
        <button class="btn btn-game" onclick="Sound.click(); goPage('game-select')">ğŸ® ê²Œì„ ì‹œì‘í•˜ê¸°</button>
        
        <div style="margin-top: 30px; font-size: 14px; color: rgba(0,0,0,0.5);">
             <span style="text-decoration: underline; cursor: pointer;" onclick="resetData()">[ê´€ë¦¬ì ë°ì´í„° ì´ˆê¸°í™”]</span>
        </div>
    </div>

    <div id="game-select-page" class="page" style="justify-content: flex-start; padding-top: 110px;">
        <button class="btn btn-home" onclick="Sound.click(); goHome()">ğŸ  í™ˆ</button>
        <div class="content-title">ğŸ® ê²Œì„ì„ ì„ íƒí•˜ì„¸ìš”</div>
        <button class="btn btn-select-sort" onclick="Sound.click(); selectGame('sorting')">
            <div style="text-align:left;">
                <div style="font-size:22px; color:#27ae60;">â™»ï¸ <b>ë¶„ë¦¬ë°°ì¶œ ë§ˆìŠ¤í„°</b></div>
                <div style="font-size:13px; font-weight:normal; color:#555; margin-top:3px;">ì“°ë ˆê¸°ë¥¼ ì˜¬ë°”ë¥´ê²Œ ë‹´ìœ¼ì„¸ìš”!</div>
            </div>
            <div style="font-size:24px;">ğŸ‘‰</div>
        </button>
        <button class="btn btn-select-pipe" onclick="Sound.click(); selectGame('pipe')">
            <div style="text-align:left;">
                <div style="font-size:22px; color:#c0392b;">â™¨ï¸ <b>ì˜¨ìˆ˜ ê³µê¸‰ ëŒ€ì‘ì „</b></div>
                <div style="font-size:13px; font-weight:normal; color:#555; margin-top:3px;">ìœ„ì—ì„œ ì•„ë˜ë¡œ ë°°ê´€ ì—°ê²°!</div>
            </div>
            <div style="font-size:24px;">ğŸ‘‰</div>
        </button>
        <button class="btn btn-select-shooter" onclick="Sound.click(); selectGame('shooter')">
            <div style="text-align:left;">
                <div style="font-size:22px; color:#9b59b6;">ğŸš€ <b>ì˜¤ì—¼ë¬¼ì§ˆ ì œë¡œ ë¯¸ì…˜</b></div>
                <div style="font-size:13px; font-weight:normal; color:#555; margin-top:3px;">ë ˆì´ì €ì™€ ìœ ë„íƒ„ìœ¼ë¡œ ì†Œíƒ•!</div>
            </div>
            <div style="font-size:24px;">ğŸ‘‰</div>
        </button>
        <button class="btn btn-select-sichuan" onclick="Sound.click(); selectGame('sichuan')">
            <div style="text-align:left;">
                <div style="font-size:22px; color:#f39c12;">ğŸ§© <b>ì—ì½” ì •í™” ë§í¬</b></div>
                <div style="font-size:13px; font-weight:normal; color:#555; margin-top:3px;">ì˜¤ì—¼ë¬¼ì§ˆê³¼ ì •í™”ì•½í’ˆì„ ì—°ê²°!</div>
            </div>
            <div style="font-size:24px;">ğŸ‘‰</div>
        </button>
        <div style="height: 50px;"></div>
    </div>

    <div id="notice-page" class="page" style="justify-content: flex-start; padding-top: 110px;">
        <button class="btn btn-home" onclick="Sound.click(); goHome()">ğŸ  í™ˆ</button>
        <div class="content-title">ğŸ“¢ ì´ìš© ì•ˆë‚´ì‚¬í•­</div>
        <div id="notice-content" class="content-box white-panel"></div>
        <div style="height: 50px;"></div>
    </div>

    <div id="promo-page" class="page" style="justify-content: flex-start; padding-top: 110px;">
        <button class="btn btn-home" onclick="Sound.click(); goHome()">ğŸ  í™ˆ</button>
        <div class="content-title">ğŸ¢ ê¹¨ë—í•œ ê¹€í¬, ë§‘ì€ ì—ë„ˆì§€</div>
        <div id="promo-content" class="content-box white-panel"></div>
        <div style="height: 50px;"></div>
    </div>

    <div id="process-page" class="page" style="justify-content: flex-start; padding-top: 100px;">
        <button class="btn btn-home" onclick="Sound.click(); goPage('promo')">ğŸ”™ ë’¤ë¡œ</button>
        
        <div class="content-title" style="margin-bottom:5px;">ğŸ­ ìì›í™”ì„¼í„° ì„¸ë¶€ ê³µì •</div>
        <div style="font-size:15px; color:#fff; text-shadow: 1px 1px 2px rgba(0,0,0,0.4); margin-bottom:15px;">(ê° ë‹¨ê³„ë¥¼ í„°ì¹˜í•˜ë©´ ì„¤ëª…ì´ ë¿…! ë‚˜ì˜µë‹ˆë‹¤)</div>
        
        <div class="process-flow-container" style="width:100%; display:flex; flex-direction:column; align-items:center; padding-bottom: 100px;">
            
            <div class="process-step" style="border-color: #8e44ad;" onclick="toggleBubble(this, '#8e44ad')">
                <div class="step-icon">ğŸššğŸ—ï¸</div>
                <div class="step-title">1. ë°˜ì… ë° ì €ì¥ì„¤ë¹„</div>
                <div class="speech-bubble">ì“°ë ˆê¸°ë¥¼ ë°˜ì…ì¥ ë²™ì»¤ì— ëª¨ìœ¼ê³ , ê±°ëŒ€í•œ í¬ë ˆì¸ìœ¼ë¡œ ì˜ ì„ì–´ì„œ í˜¸í¼ë¡œ ì™ ë„£ì–´ìš”! (ì•…ì·¨ì œê±°ì„¤ë¹„ë„ ê°€ë™ ì¤‘ì…ë‹ˆë‹¤)</div>
            </div>
            <div class="step-arrow">â¬‡ï¸</div>
            
            <div class="process-step" style="border-color: #e74c3c;" onclick="toggleBubble(this, '#e74c3c')">
                <div class="step-icon">ğŸ”¥ğŸŒªï¸</div>
                <div class="step-title">2. ê°€ìŠ¤í™” ë° ìš©ìœµ (1200â„ƒ)</div>
                <div class="speech-bubble">ê°€ìŠ¤í™”ë¡œì™€ ì„ íšŒìš©ìœµë¡œë¥¼ ê±°ì³ 1200â„ƒ ì´ìƒì˜ ì´ˆê³ ì˜¨ìœ¼ë¡œ ì“°ë ˆê¸°ë¥¼ ì™„ë²½í•˜ê²Œ íƒœìš°ê³  ë…¹ì—¬ ì•ˆì „í•œ ìŠ¬ë˜ê·¸ë¡œ ë§Œë“­ë‹ˆë‹¤.</div>
            </div>
            <div class="step-arrow">â¬‡ï¸</div>
            
            <div class="process-step" style="border-color: #e67e22;" onclick="toggleBubble(this, '#e67e22')">
                <div class="step-icon">â™¨ï¸ğŸŠ</div>
                <div class="step-title">3. íì—´ë³´ì¼ëŸ¬ (ì—ë„ˆì§€ íšŒìˆ˜)</div>
                <div class="speech-bubble">í„í„ ë“ëŠ” ì—°ì†Œê°€ìŠ¤ë¥¼ ëƒ‰ê°ì‹œí‚¤ë©´ì„œ ë¬¼ì„ ë“ì—¬ ì¦ê¸°ë¥¼ ë§Œë“­ë‹ˆë‹¤. ë°œìƒí•œ ì¦ê¸°ëŠ” ìŠ¤í¬ì¸ ì„¼í„° ìˆ˜ì˜ì¥ì— ì˜¨ìˆ˜ë¥¼ ê³µê¸‰í•˜ê³  ì¸ê·¼ ì§€ì—­ë‚œë°©ì— ì•Œì°¨ê²Œ í™œìš©ë©ë‹ˆë‹¤!</div>
            </div>
            <div class="step-arrow">â¬‡ï¸</div>
            
            <div class="process-step" style="border-color: #2ecc71;" onclick="toggleBubble(this, '#2ecc71')">
                <div class="step-icon">ğŸ§ªğŸ’¦</div>
                <div class="step-title">4. ë°˜ê±´ì‹ ë°˜ì‘íƒ‘</div>
                <div class="speech-bubble">ì•¡ìƒì†Œì„íšŒë¥¼ ë¿œì–´ì„œ, ì—°ì†Œê°€ìŠ¤ ì† ë‚˜ìœ ì‚°ì„± ê°€ìŠ¤(ì—¼í™”ìˆ˜ì†Œ, í™©ì‚°í™”ë¬¼ ë“±)ë¥¼ ì¤‘í™”ì‹œí‚¤ëŠ” 1ì°¨ ì •í™” êµ¬ì—­ì…ë‹ˆë‹¤.</div>
            </div>
            <div class="step-arrow">â¬‡ï¸</div>
            
            <div class="process-step" style="border-color: #34495e;" onclick="toggleBubble(this, '#34495e')">
                <div class="step-icon">ğŸ˜·ğŸ§½</div>
                <div class="step-title">5. ì—¬ê³¼ì§‘ì§„ê¸°</div>
                <div class="speech-bubble">ê±°ëŒ€í•œ ë¯¸ì„¸ í•„í„°(ë°±í•„í„°)ì™€ í™œì„±íƒ„ì„ ì´ìš©í•´, ë¯¸ì„¸ë¨¼ì§€(ë¶„ì§„)ì™€ ë‚¨ì€ ë‹¤ì´ì˜¥ì‹ ì„ ê¼¼ê¼¼í•˜ê²Œ ê±¸ëŸ¬ë‚´ëŠ” í•µì‹¬ ì •í™” ì¥ì¹˜ì…ë‹ˆë‹¤!</div>
            </div>
            <div class="step-arrow">â¬‡ï¸</div>
            
            <div class="process-step" style="border-color: #2980b9;" onclick="toggleBubble(this, '#2980b9')">
                <div class="step-icon">â™»ï¸âœ¨</div>
                <div class="step-title">6. ì„ íƒì  ì´‰ë§¤í™˜ì›íƒ‘ (SCR)</div>
                <div class="speech-bubble">ì•”ëª¨ë‹ˆì•„ë¥¼ ë¿Œë¦¬ê³  íŠ¹ìˆ˜ ì´‰ë§¤ë¥¼ í†µê³¼ì‹œì¼œ, ì˜¨ì‹¤ê°€ìŠ¤ì˜ ì›ì¸ ì§ˆì†Œì‚°í™”ë¬¼(NOx)ì„ ì¸ì²´ì— ë¬´í•´í•œ ë¬¼ê³¼ ì§ˆì†Œë¡œ ì™„ë²½ ë¶„í•´í•©ë‹ˆë‹¤.</div>
            </div>
            <div class="step-arrow">â¬‡ï¸</div>
            
            <div class="process-step" style="border-color: #00cec9;" onclick="toggleBubble(this, '#00cec9')">
                <div class="step-icon">ğŸ­â˜ï¸</div>
                <div class="step-title">7. ìœ ì¸ì†¡í’ê¸° & êµ´ëš</div>
                <div class="speech-bubble">3ë‹¨ê³„ì˜ ì² ì €í•œ ì •í™”ë¥¼ ê±°ì³ ì™„ë²½í•˜ê²Œ ê¹¨ë—í•´ì§„ ê³µê¸°ë§Œì„ ê°•ë ¥í•œ ì†¡í’ê¸°ë¡œ ë°€ì–´ë‚´ì–´, êµ´ëšì„ í†µí•´ í•˜ì–€ ìˆ˜ì¦ê¸°ë¡œ ë‚´ë³´ëƒ…ë‹ˆë‹¤!</div>
            </div>
            
        </div>
    </div>

    <div id="game-play-page" class="page" style="display:none; overflow: hidden;">
        
        <button id="ingame-home-btn" class="btn-exit-game" style="display:none;" onclick="forceQuitGame()">ğŸšª ë‚˜ê°€ê¸°</button>

        <div id="score-board"></div>
        <canvas id="gameCanvas"></canvas>
        
        <div id="hint-btn" class="btn-hint" onclick="Sound.click(); showHint()">ğŸ’¡</div>

        <div id="game-ui-layer">
            <h1 id="gameTitle" style="font-size: 40px; margin-bottom: 20px; color:#fff; text-shadow: 3px 3px 0 #000;">ê²Œì„ ì œëª©</h1>
            <div id="gameGuide" class="white-panel" style="width: 80%; text-align:center; font-size:20px;">ê°€ì´ë“œ ë‚´ìš©</div>
            <div id="rankArea" class="white-panel" style="display:none; width:90%; max-width:500px; flex-direction:column; align-items:center; padding:15px;">
                <div style="font-size:26px; color:#e67e22; font-weight:bold; margin-bottom:5px;">ğŸ† ëª…ì˜ˆì˜ ì „ë‹¹ ğŸ†</div>
                <div id="rank-board" style="width:100%;"></div>
                <div id="eco-quote" style="margin-top:10px; font-size:16px; color:#27ae60; background:#e8f8f5; padding:10px; border-radius:10px; line-height:1.4;"></div>
            </div>
            <div id="start-btn-area"><div class="blink" onclick="Sound.click(); startGame()">í„°ì¹˜í•˜ì—¬ ì‹œì‘</div></div>
            <div id="gameover-btn-area" style="display:none; margin-top:15px;">
                <button class="btn btn-restart" onclick="Sound.click(); startGame()">ğŸ”„ ë‹¤ì‹œ í•˜ê¸°</button>
                <button class="btn btn-quit" onclick="Sound.click(); goPage('game-select')">ğŸ”™ ê²Œì„ ì„ íƒ</button>
                <button class="btn btn-quit" onclick="Sound.click(); goHome()">ğŸ  í™ˆìœ¼ë¡œ</button>
            </div>
        </div>
    </div>

<script>
    // =========================================================================
    // ğŸ’¡ [í…ìŠ¤íŠ¸ ì„¤ì •] ì•ˆë‚´ì‚¬í•­, í™ë³´ë‚´ìš©, ëœë¤ ë¬¸êµ¬ë¥¼ ì—¬ê¸°ì„œ ì†ì‰½ê²Œ ìˆ˜ì •í•˜ì„¸ìš”!
    // =========================================================================
    const CONFIG = {
        noticeText: `
            <p>âœ… <b style="color:#27ae60;">ë°˜ì… ê°€ëŠ¥ íê¸°ë¬¼ (ì†Œê°ìš©):</b><br>ì¢…ëŸ‰ì œ ë´‰íˆ¬ì— ë‹´ê¸´ ê°€ì—°ì„± ì“°ë ˆê¸°, ì¬ì‚¬ìš© ë¶ˆê°€ëŠ¥í•œ í—Œì˜· ë“± íƒ€ëŠ” ì“°ë ˆê¸°.</p><br>
            <p>âŒ <b style="color:#c0392b;">ë°˜ì… ë¶ˆê°€ íê¸°ë¬¼:</b><br>ìŒì‹ë¬¼ë¥˜, ì¬í™œìš©í’ˆ(ì¢…ì´ë¥˜, ìº”, ë³‘, í”Œë¼ìŠ¤í‹±), ì‚¬ì—…ì¥íê¸°ë¬¼, í­ë°œì„± ìœ„í—˜ë¬¼.</p>
            <br><hr style="border: 1px dashed #ccc; margin: 10px 0;"><br>
            <p style="font-size: 16px; line-height: 1.8;">ğŸ“ <b style="color:#2c3e50;">ë¬¸ì˜ì²˜ ì•ˆë‚´:</b><br>
            <span style="font-size:14px; color:#7f8c8d;">(ë²ˆí˜¸ë¥¼ í„°ì¹˜í•˜ë©´ ë°”ë¡œ í†µí™”ê°€ ì—°ê²°ë©ë‹ˆë‹¤)</span><br><br>
            - <b>íê¸°ë¬¼ í—ˆê°€/ë°°ì¶œ:</b> ê¹€í¬ì‹œì²­ ìì›ìˆœí™˜ê³¼<br>
              ğŸ‘‰ <a href="tel:031-980-2767" style="color:#2980b9; font-weight:bold; text-decoration:none; background:#ecf0f1; padding:4px 10px; border-radius:8px; display:inline-block; margin-top:5px; margin-bottom:10px;">â˜ 031-980-2767</a><br>
            - <b>í¬ë¦°ë„· í‚¤ êµ¬ì…:</b> ë¸Œë‹ˆì—˜ë„¤ì´ì²˜<br>
              ğŸ‘‰ <a href="tel:031-981-6081" style="color:#2980b9; font-weight:bold; text-decoration:none; background:#ecf0f1; padding:4px 10px; border-radius:8px; display:inline-block; margin-top:5px;">â˜ 031-981-6081</a></p>
        `,
        promoText: `
            <p>ğŸŒ± <b style="color:#27ae60;">ì¹œí™˜ê²½ ì†Œê° ê¸°ìˆ :</b><br>ìµœì²¨ë‹¨ ì˜¤ì—¼ ë°©ì§€ ì‹œì„¤ì„ í†µí•´ ë‹¤ì´ì˜¥ì‹  ë“± ìœ í•´ ë¬¼ì§ˆì„ ì™„ë²½í•˜ê²Œ ì œê±°í•©ë‹ˆë‹¤.</p><br>
            <p>âš¡ <b style="color:#f39c12;">íê¸°ë¬¼ì„ ì—ë„ˆì§€ë¡œ:</b><br>ì“°ë ˆê¸°ë¥¼ íƒœìš¸ ë•Œ ë°œìƒí•˜ëŠ” ì—´ì„ ì´ìš©í•˜ì—¬ ìŠ¤í¬ì¸ ì„¼í„°ì— ì˜¨ìˆ˜ì™€ ëƒ‰ë‚œë°©ì„ í•˜ê³  ë‚¨ì€ ì—´ì€ ì§€ì—­ ë‚œë°©ì— ê³µê¸‰í•©ë‹ˆë‹¤.</p><br>
            <p>ğŸŠ <b style="color:#2980b9;">ì£¼ë¯¼ê³¼ í•¨ê»˜í•˜ëŠ” ê³µê°„:</b><br>ìˆ˜ì˜ì¥, í—¬ìŠ¤ì¥ ë“± ì£¼ë¯¼ í¸ìµ ì‹œì„¤ì„ ìš´ì˜í•˜ë©° ì§€ì—­ ì‚¬íšŒì™€ ìƒìƒí•©ë‹ˆë‹¤.</p>
            
            <div style="text-align:center; margin-top:25px;">
                <button class="btn btn-promo" style="font-size:22px; padding:15px; width:100%; box-shadow:0 4px 10px rgba(0,0,0,0.2);" onclick="Sound.click(); goPage('process')">
                    ğŸ” ì• ë‹ˆë©”ì´ì…˜ ê³µì •íë¦„ë„ ë³´ê¸°
                </button>
            </div>
        `,
        ecoQuotes: [
            "ğŸŒ± í™˜ê²½ë³´í˜¸ëŠ” ë‚˜ ìì‹ ë¶€í„°",
            "ğŸ­ ìì›í™”ì„¼í„°ëŠ” ê¹¨ë—í•œ ê¹€í¬ë¥¼ ìœ„í•´ í•­ìƒ ë…¸ë ¥í•©ë‹ˆë‹¤",
            "â™»ï¸ ì˜¬ë°”ë¥¸ ë¶„ë¦¬ìˆ˜ê±°ëŠ” ë¯¸ë˜ë¥¼ ìœ„í•œ ì²« ë…¸ë ¥",
            "ğŸ’§ ì•„ê»´ ì“´ ìì›, í›„ëŒ€ì—ê²Œ ë¬¼ë ¤ì¤„ ì†Œì¤‘í•œ ìœ ì‚°ì…ë‹ˆë‹¤",
            "âœ¨ ê¹¨ë—í•œ ê¹€í¬, ë§‘ì€ ì—ë„ˆì§€! ìš°ë¦¬ê°€ ë§Œë“¤ì–´ê°‘ë‹ˆë‹¤"
        ]
    };
    // =========================================================================

    function toggleBubble(element, color) {
        Sound.click();
        var isActive = element.classList.contains('active');
        
        document.querySelectorAll('.process-step.active').forEach(step => {
            step.classList.remove('active');
        });
        
        if (!isActive) {
            element.classList.add('active');
            var bubble = element.querySelector('.speech-bubble');
            if(bubble) {
                bubble.style.borderColor = color;
            }
            setTimeout(() => {
                element.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }, 50);
        }
    }


    // --- ğŸ§ ì‚¬ìš´ë“œ ë§¤ë‹ˆì € ---
    const Sound = {
        ctx: null, bgmInterval: null, isSoundOn: false,
        init: function() {
            if(!this.ctx) { 
                this.ctx = new (window.AudioContext || window.webkitAudioContext)(); 
            }
            if(this.ctx.state === 'suspended') {
                this.ctx.resume();
            }
        },
        playTone: function(freq, type, duration, vol) {
            this.init(); 
            if(!this.ctx || this.ctx.state !== 'running' || !this.isSoundOn) return; 
            let osc = this.ctx.createOscillator(); 
            let gain = this.ctx.createGain();
            osc.type = type; 
            osc.frequency.setValueAtTime(freq, this.ctx.currentTime);
            gain.gain.setValueAtTime(vol, this.ctx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.001, this.ctx.currentTime + duration);
            osc.connect(gain); 
            gain.connect(this.ctx.destination);
            osc.start(); 
            osc.stop(this.ctx.currentTime + duration);
        },
        playNoise: function(duration, vol) {
            this.init();
            if(!this.ctx || this.ctx.state !== 'running' || !this.isSoundOn) return; 
            let bufferSize = this.ctx.sampleRate * duration;
            let buffer = this.ctx.createBuffer(1, bufferSize, this.ctx.sampleRate);
            let data = buffer.getChannelData(0);
            for (let i = 0; i < bufferSize; i++) data[i] = Math.random() * 2 - 1;
            let noise = this.ctx.createBufferSource(); noise.buffer = buffer;
            let gain = this.ctx.createGain();
            gain.gain.setValueAtTime(vol, this.ctx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.001, this.ctx.currentTime + duration);
            noise.connect(gain); gain.connect(this.ctx.destination); noise.start();
        },
        shoot: function() { this.playTone(800, 'square', 0.1, 0.08); },
        explosion: function() { this.playNoise(0.3, 0.3); },
        score: function() { this.playTone(600, 'sine', 0.1, 0.2); setTimeout(()=>this.playTone(800, 'sine', 0.15, 0.2), 100); },
        error: function() { this.playTone(150, 'sawtooth', 0.4, 0.3); },
        click: function() { this.playTone(500, 'sine', 0.05, 0.2); },
        levelUp: function() { [440, 554, 659, 880].forEach((f, i) => setTimeout(() => this.playTone(f, 'square', 0.2, 0.2), i * 120)); },
        toggleBGM: function() {
            this.init();
            this.isSoundOn = !this.isSoundOn;
            let btn = document.getElementById('bgm-toggle');
            if(btn) btn.innerText = this.isSoundOn ? "ğŸ”Š ì‚¬ìš´ë“œ: ON" : "ğŸ”‡ ì‚¬ìš´ë“œ: OFF";
            
            if(this.isSoundOn) {
                const melody = [
                    261.6, 329.6, 392.0, 523.3, 392.0, 329.6, 
                    349.2, 440.0, 523.3, 698.5, 523.3, 440.0, 
                    392.0, 493.9, 587.3, 784.0, 587.3, 493.9  
                ]; 
                let idx = 0;
                if(this.bgmInterval) clearInterval(this.bgmInterval);
                
                this.bgmInterval = setInterval(() => {
                    if(this.ctx && this.ctx.state === 'running' && this.isSoundOn) {
                        let osc = this.ctx.createOscillator(); let gain = this.ctx.createGain();
                        osc.type = 'square'; osc.frequency.setValueAtTime(melody[idx], this.ctx.currentTime);
                        gain.gain.setValueAtTime(0.1, this.ctx.currentTime);
                        gain.gain.exponentialRampToValueAtTime(0.001, this.ctx.currentTime + 0.15);
                        osc.connect(gain); gain.connect(this.ctx.destination);
                        osc.start(); osc.stop(this.ctx.currentTime + 0.15);
                    }
                    idx = (idx + 1) % melody.length;
                }, 200); 
            } else {
                clearInterval(this.bgmInterval);
            }
        }
    };

    let audioUnlocked = false;
    function unlockAudio() {
        if (audioUnlocked) return;
        Sound.init();
        if(Sound.ctx) {
            Sound.ctx.resume().then(() => {
                let buffer = Sound.ctx.createBuffer(1, 1, 22050);
                let source = Sound.ctx.createBufferSource();
                source.buffer = buffer;
                source.connect(Sound.ctx.destination);
                source.start(0);
                audioUnlocked = true;
                if (!Sound.isSoundOn) { Sound.toggleBGM(); }
            });
        }
    }
    
    document.body.addEventListener('touchstart', unlockAudio, {once:true});
    document.body.addEventListener('click', unlockAudio, {once:true});

    if ('serviceWorker' in navigator) { window.addEventListener('load', () => { navigator.serviceWorker.register('./service-worker.js').catch(err => console.log(err)); }); }
    function safeGetItem(key) { try { return localStorage.getItem(key); } catch(e) { return "0"; } }
    function safeSetItem(key, val) { try { localStorage.setItem(key, val); } catch(e) {} }
    function safeClear() { try { localStorage.clear(); } catch(e) {} }

    function createBackgroundShapes() {
        const container = document.getElementById('background-shapes');
        const icons = ['ğŸŒ±', 'ğŸ’§', 'â™»ï¸', 'â˜ï¸', 'ğŸ‚', 'âœ¨', 'ğŸ­'];
        for(let i=0; i<20; i++) {
            let el = document.createElement('div'); el.classList.add('bg-icon');
            el.innerText = icons[Math.floor(Math.random() * icons.length)];
            el.style.left = Math.random() * 100 + '%';
            el.style.animationDuration = (Math.random() * 8 + 12) + 's'; 
            el.style.animationDelay = (Math.random() * 10) + 's';
            el.style.fontSize = (Math.random() * 30 + 40) + 'px';
            container.appendChild(el);
        }
    }
    createBackgroundShapes();

    var totalPlayCount = 0; var currentGameMode = ''; var gameTimeLeft = 30;
    var logoCanvas = document.getElementById('logoCanvas'); var logoCtx = logoCanvas.getContext('2d');
    var logoSmoke = []; var logoFrame = 0; var logoAnimId;

    window.onload = function() { 
        document.getElementById('notice-content').innerHTML = CONFIG.noticeText;
        document.getElementById('promo-content').innerHTML = CONFIG.promoText;
        resize(); window.addEventListener('resize', resize); updateMainCounter(); startMenuLogo(); 
    };

    function startMenuLogo() { if(logoAnimId) cancelAnimationFrame(logoAnimId); logoSmoke = []; animLoopLogo(); }
    function animLoopLogo() { logoFrame++; drawMenuLogo(); logoAnimId = requestAnimationFrame(animLoopLogo); }
    function drawMenuLogo() {
        logoCtx.clearRect(0,0, 200, 160); var cx = 100; var cy = 100;
        logoCtx.save(); logoCtx.shadowBlur = 10; logoCtx.shadowColor = 'rgba(0,0,0,0.2)';
        logoCtx.fillStyle = '#f1f2f6'; logoCtx.fillRect(cx - 60, cy, 80, 50); logoCtx.fillRect(cx - 20, cy - 20, 70, 70);
        logoCtx.strokeStyle = '#ced6e0'; logoCtx.lineWidth=3; logoCtx.strokeRect(cx-60, cy, 80, 50); logoCtx.strokeRect(cx-20, cy-20, 70, 70);
        logoCtx.fillStyle = '#70a1ff'; logoCtx.fillRect(cx - 50, cy + 10, 15, 15); logoCtx.fillRect(cx - 30, cy + 10, 15, 15); logoCtx.fillRect(cx - 10, cy - 10, 50, 10); logoCtx.fillRect(cx - 10, cy + 10, 50, 30); 
        logoCtx.fillStyle = '#a4b0be'; logoCtx.fillRect(cx + 30, cy - 70, 15, 60); 
        logoCtx.fillStyle = '#ff6b81'; logoCtx.fillRect(cx + 30, cy - 65, 15, 6);
        logoCtx.fillStyle = '#2ed573'; logoCtx.beginPath(); logoCtx.ellipse(cx + 5, cy + 25, 10, 18, Math.PI/4, 0, Math.PI*2); logoCtx.fill();
        logoCtx.restore();
        if(logoFrame % 10 === 0) logoSmoke.push({x: cx + 37, y: cy - 75, r: 5, alpha: 0.8});
        for(var i=0; i<logoSmoke.length; i++) {
            var s = logoSmoke[i]; s.y -= 1.2; s.x += Math.sin(logoFrame*0.05 + i) * 0.5; s.r += 0.15; s.alpha -= 0.015;
            logoCtx.fillStyle = 'rgba(255, 255, 255, ' + s.alpha + ')'; logoCtx.beginPath(); logoCtx.arc(s.x, s.y, s.r, 0, Math.PI*2); logoCtx.fill();
            if(s.alpha <= 0) { logoSmoke.splice(i, 1); i--; }
        }
    }

    function increaseUserCount() { totalPlayCount = parseInt(safeGetItem('gimpoPlayCount') || "0"); totalPlayCount++; safeSetItem('gimpoPlayCount', totalPlayCount); updateMainCounter(); }
    function updateMainCounter() { var count = parseInt(safeGetItem('gimpoPlayCount') || "0"); var el = document.getElementById('mainUserCount'); if(el) el.innerText = count; }
    
    function forceQuitGame() {
        Sound.click();
        if (confirm("ê²Œì„ì„ ì¤‘ë‹¨í•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì§€ê¸ˆê¹Œì§€ì˜ ê¸°ë¡ì´ ëª…ì˜ˆì˜ ì „ë‹¹ì— ì €ì¥ë©ë‹ˆë‹¤.")) {
            document.getElementById('ingame-home-btn').style.display = 'none';
            gameRunning = false; 
            
            if(currentGameMode === 'pipe' || currentGameMode === 'sichuan') score += (currentLevel - 1) * 1000; 
            
            saveScore(score); 
            showRanking(); 
            showRandomEcoQuote();
            
            uiLayer.style.display = 'flex'; 
            uiLayer.style.background = 'rgba(0,0,0,0.95)'; 
            gameTitle.innerText = "ğŸ›‘ ë¯¸ì…˜ ì¤‘ë‹¨"; 
            gameGuide.innerHTML = "<span style='color:#3498db; font-size:24px; font-weight:bold;'>[ í”Œë ˆì´ ì¢…ë£Œ ]</span><br><br>ìµœì¢… ì ìˆ˜: " + score; 
            
            rankArea.style.display = 'flex'; 
            startBtnArea.style.display = 'none'; 
            gameoverBtnArea.style.display = 'block'; 
        }
    }

    function goPage(pageName) {
        document.querySelectorAll('.page').forEach(p => p.style.display = 'none');
        document.getElementById('ingame-home-btn').style.display = 'none';

        if(logoAnimId && pageName !== 'main') cancelAnimationFrame(logoAnimId);
        
        if (pageName === 'game-select') document.getElementById('game-select-page').style.display = 'flex';
        else if (pageName === 'game-play') document.getElementById('game-play-page').style.display = 'block';
        else if (pageName === 'notice') { document.getElementById('notice-page').style.display = 'flex'; increaseUserCount(); }
        else if (pageName === 'promo') { document.getElementById('promo-page').style.display = 'flex'; increaseUserCount(); }
        else if (pageName === 'process') { document.getElementById('process-page').style.display = 'flex'; }
        else { document.getElementById('main-menu').style.display = 'flex'; updateMainCounter(); startMenuLogo(); }
    }
    function goHome() { gameRunning = false; goPage('main'); }
    function resetData() { 
        var pwd = prompt("ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”:");
        if (pwd === "9730") { if(confirm("ì´ˆê¸°í™” í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) { safeClear(); alert("ì™„ë£Œ"); location.reload(); } } else if(pwd!==null) alert("ë¹„ë°€ë²ˆí˜¸ ì˜¤ë¥˜");
    }

    function drawRoundRect(ctx, x, y, width, height, radius) {
        if (width < 0) width = 0; if (height < 0) height = 0;
        ctx.beginPath(); ctx.moveTo(x + radius, y); ctx.lineTo(x + width - radius, y); ctx.quadraticCurveTo(x + width, y, x + width, y + radius);
        ctx.lineTo(x + width, y + height - radius); ctx.quadraticCurveTo(x + width, y + height, x + width - radius, y + height); ctx.lineTo(x + radius, y + height);
        ctx.quadraticCurveTo(x, y + height, x, y + height - radius); ctx.lineTo(x, y + radius); ctx.quadraticCurveTo(x, y, x + radius, y); ctx.closePath();
    }

    var uiLayer = document.getElementById('game-ui-layer'); var gameTitle = document.getElementById('gameTitle'); var gameGuide = document.getElementById('gameGuide'); var startBtnArea = document.getElementById('start-btn-area'); var gameoverBtnArea = document.getElementById('gameover-btn-area'); var rankArea = document.getElementById('rankArea'); var scoreBoard = document.getElementById('score-board'); var rankBoard = document.getElementById('rank-board'); var canvas = document.getElementById('gameCanvas'); var ctx = canvas.getContext('2d');
    var hintBtn = document.getElementById('hint-btn');
    var ecoQuoteArea = document.getElementById('eco-quote');

    function selectGame(mode) {
        currentGameMode = mode; goPage('game-play'); resize(); 
        uiLayer.style.display = 'flex'; uiLayer.style.background = 'rgba(0,0,0,0.85)';
        rankArea.style.display = 'none'; startBtnArea.style.display = 'block'; gameoverBtnArea.style.display = 'none';
        document.getElementById('ingame-home-btn').style.display = 'none';

        if (mode === 'sorting') {
            gameTitle.innerText = "ë¶„ë¦¬ë°°ì¶œ ë§ˆìŠ¤í„°";
            gameGuide.innerHTML = "â­• <b>ë¨¹ê¸°:</b> íœ´ì§€, ë§ˆìŠ¤í¬, ë¼ˆ, í—Œì˜·<br>âŒ <b>í”¼í•˜ê¸°:</b> ê±´ì „ì§€, ìŒì‹ë¬¼, ê³ ì² , ë³‘";
            scoreBoard.innerHTML = "ì ìˆ˜: <span id='scoreVal'>0</span>";
            hintBtn.style.display = 'none';
        } else if (mode === 'pipe') {
            gameTitle.innerText = "ì˜¨ìˆ˜ ê³µê¸‰ ëŒ€ì‘ì „";
            gameGuide.innerHTML = "ğŸ”¥ì†Œê°ì¥ â†’ ğŸŠìˆ˜ì˜ì¥<br>ìœ„ì—ì„œ ì•„ë˜ë¡œ ë°°ê´€ì„ ì—°ê²°í•˜ì„¸ìš”!";
            scoreBoard.innerHTML = "Lv <span id='lvlVal'>1</span> | <span id='timerVal'>30</span>ì´ˆ";
            hintBtn.style.display = 'flex'; 
        } else if (mode === 'shooter') {
            gameTitle.innerText = "ì˜¤ì—¼ë¬¼ì§ˆ ì œë¡œ ë¯¸ì…˜";
            gameGuide.innerHTML = "<b style='color:#9b59b6; font-size:26px;'>ë ˆì´ì €(3) + ìœ ë„íƒ„(5)</b><br><br><b>ê²Œì´íŠ¸</b>ë¥¼ í†µê³¼í•´ ë¬´ê¸°ë¥¼ ëŠ˜ë¦¬ê³ <br>ìŠ¤ë§ˆíŠ¸ ìœ ë„íƒ„ìœ¼ë¡œ ì ì„ ì¶”ì í•˜ì„¸ìš”!";
            scoreBoard.innerHTML = "Lv <span id='lvlVal'>1</span> | ì ìˆ˜: <span id='scoreVal'>0</span> | ì˜¤ì—¼ë„: <span id='pollutionVal'>0</span>%";
            hintBtn.style.display = 'none';
        } else if (mode === 'sichuan') {
            gameTitle.innerText = "ì—ì½” ì •í™” ë§í¬";
            gameGuide.innerHTML = "<b style='color:#f39c12; font-size:24px;'>ì˜¤ì—¼ë¬¼ì§ˆê³¼ ì •í™”ì„¤ë¹„ë¥¼ ì§ì§€ì–´ì£¼ì„¸ìš”!</b><br><br><span style='color:#3498db'>â˜ï¸NOx â†” ğŸ’§ì•”ëª¨ë‹ˆì•„</span><br><span style='color:#e74c3c'>â˜ ï¸HCl â†” ğŸ§‚ì†Œì„íšŒ</span><br><span style='color:#2ecc71'>ğŸŒ«ï¸ë¨¼ì§€ â†” âš™ï¸ì§‘ì§„ê¸°</span><br><span style='color:#9b59b6'>â˜£ï¸ë‹¤ì´ì˜¥ì‹  â†” ğŸª¨í™œì„±íƒ„</span><br><br><span style='font-size:16px; color:#bdc3c7'>ğŸ’¡ êº¾ì´ëŠ” íšŸìˆ˜ê°€ 2ë²ˆ ì´í•˜ì¼ ë•Œë§Œ íŒŒê´´ë©ë‹ˆë‹¤!</span>";
            scoreBoard.innerHTML = "Lv <span id='lvlVal'>1</span> | ì ìˆ˜: <span id='scoreVal'>0</span> | <span id='timerVal'>60</span>ì´ˆ";
            hintBtn.style.display = 'flex'; 
        }
    }

    var gameRunning = false; var score = 0; var frameCount = 0; var screenWidth = window.innerWidth; var screenHeight = window.innerHeight; var currentLevel = 1;
    var player = { x: 0, y: 0, size: 105, speed: 8 }; var enemies = []; var inputLeft = false; var inputRight = false; var isDragging = false; var dragOffsetX = 0;
    
    var itemsList = [ 
        { text: "ğŸ§»", type: 1, name: "ë”ëŸ¬ìš´ íœ´ì§€" }, { text: "ğŸ˜·", type: 1, name: "ë§ˆìŠ¤í¬" }, { text: "ğŸ¦´", type: 1, name: "ë¼ˆë‹¤ê·€" }, { text: "ğŸ§£", type: 1, name: "í—ê²Š" }, { text: "ğŸ‘•", type: 1, name: "í—Œ ì˜·" },
        { text: "ğŸ”‹", type: 0, name: "ê±´ì „ì§€" }, { text: "ğŸ", type: 0, name: "ìŒì‹ë¬¼" }, { text: "ğŸ”©", type: 0, name: "ê³ ì² " }, { text: "ğŸ¾", type: 0, name: "ë¹ˆ ë³‘" }
    ];

    var gridCols = 3; var gridRows = 3; var cellSize = 0; var grid = []; var pipeOffsetX = 0; var pipeOffsetY = 0; var isPipeSolved = false; var solveAnimTimer = 0; var startCol = 0; var endCol = 0; var solvedPath = [];
    var showLevelMessageTimer = 0; var isHinting = false; var hintTimer = 0;

    var bullets = []; var missiles = []; var pollutants = []; var shooterParticles = []; var floatingTexts = []; var gates = [];
    var pollutionLevel = 0; var nextHealScore = 1000; var laserCount = 1; var missileCount = 0; 
    var pollutantTypes = [
        { text: "NOx", color: "#e74c3c", name: "ì§ˆì†Œì‚°í™”ë¬¼" }, { text: "SOx", color: "#f1c40f", name: "í™©ì‚°í™”ë¬¼" }, 
        { text: "HCl", color: "#2ecc71", name: "ì—¼í™”ìˆ˜ì†Œ" }, { text: "â˜ ï¸", color: "#9b59b6", name: "ë‹¤ì´ì˜¥ì‹ " }, { text: "â˜ï¸", color: "#95a5a6", name: "ë¯¸ì„¸ë¨¼ì§€" }
    ];

    var scCols = 4; var scRows = 8; var scTileSize = 0; var scOffsetX = 0; var scOffsetY = 0;
    var scGrid = []; var scSelected = null; var scPath = null; var scPathTimer = 0; var scHintMatch = null; var scRemoving = null; 
    var scPairs = [
        { id: 1, p: "â˜ï¸NOx\n(ì§ˆì†Œ)", c: "ğŸ’§ì•”ëª¨ë‹ˆì•„", color: "#3498db" }, { id: 2, p: "â˜ ï¸HCl\n(ì—¼ì†Œ)", c: "ğŸ§‚ì†Œì„íšŒ", color: "#e74c3c" },
        { id: 3, p: "ğŸŒ«ï¸ë¨¼ì§€\n(ë¶„ì§„)", c: "âš™ï¸ì§‘ì§„ê¸°", color: "#2ecc71" }, { id: 4, p: "â˜£ï¸ë‹¤ì´ì˜¥ì‹ ", c: "ğŸª¨í™œì„±íƒ„", color: "#9b59b6" }
    ];

    var fps = 60; var fpsInterval = 1000 / fps; var then = Date.now(); var startTime = then;

    function resize() { 
        canvas.width = window.innerWidth; canvas.height = window.innerHeight; 
        screenWidth = canvas.width; screenHeight = canvas.height; 
        player.x = screenWidth / 2 - player.size / 2; player.y = screenHeight - player.size - 20; 
        if(currentGameMode === 'pipe') initPipeLevel(); 
        if(currentGameMode === 'sichuan') initSichuanLayout();
    }
    
    function startGame() { 
        gameRunning = true; score = 0; currentLevel = 1; frameCount = 0; increaseUserCount(); uiLayer.style.display = 'none'; 
        document.getElementById('ingame-home-btn').style.display = 'block';

        if(currentGameMode === 'sorting') { enemies = []; scoreBoard.innerHTML = "ì ìˆ˜: <span id='scoreVal'>0</span>"; } 
        else if(currentGameMode === 'pipe') { gameTimeLeft = 30; scoreBoard.innerHTML = "Lv <span id='lvlVal'>1</span> | <span id='timerVal'>30</span>ì´ˆ"; initPipeLevel(); } 
        else if(currentGameMode === 'shooter') {
            bullets = []; pollutants = []; shooterParticles = []; floatingTexts = []; gates = [];
            pollutionLevel = 0; nextHealScore = 1000; laserCount = 1; missileCount = 0;
            scoreBoard.innerHTML = "Lv <span id='lvlVal'>1</span> | ì ìˆ˜: <span id='scoreVal'>0</span> | ì˜¤ì—¼ë„: <span id='pollutionVal'>0</span>%";
        } 
        else if(currentGameMode === 'sichuan') {
            gameTimeLeft = 60; scoreBoard.innerHTML = "Lv <span id='lvlVal'>1</span> | ì ìˆ˜: <span id='scoreVal'>0</span> | <span id='timerVal'>60</span>ì´ˆ"; 
            shooterParticles = []; floatingTexts = []; initSichuanLayout(); initSichuanLevel();
        }
        then = Date.now(); startTime = then; loop(); 
    }
    
    function loop() { 
        if (!gameRunning) return; 
        requestAnimationFrame(loop); 
        var now = Date.now(); var elapsed = now - then;
        if (elapsed > fpsInterval) {
            then = now - (elapsed % fpsInterval);
            try {
                if (currentGameMode === 'sorting') { updateSorting(); drawSorting(); } 
                else if (currentGameMode === 'pipe') { updatePipePuzzle(); drawPipePuzzle(); }
                else if (currentGameMode === 'shooter') { updateShooter(); drawShooter(); } 
                else if (currentGameMode === 'sichuan') { updateSichuan(); drawSichuan(); }
            } catch(e) { console.error(e); } 
        }
    }

    // --- [1] ë¶„ë¦¬ë°°ì¶œ ë¡œì§ ---
    function updateSorting() {
        if (inputLeft && player.x > 0) player.x -= player.speed; 
        if (inputRight && player.x < canvas.width - player.size) player.x += player.speed;
        if (player.x < 0) player.x = 0; if (player.x > canvas.width - player.size) player.x = canvas.width - player.size;
        
        var calculatedLevel = Math.floor(score / 100) + 1; 
        if (calculatedLevel > currentLevel) { currentLevel = calculatedLevel; showLevelMsg(); }
        
        frameCount++; var spawnRate = Math.max(15, 35 - (currentLevel * 3)); 
        if (frameCount % spawnRate === 0) { 
            var size = 55; var x = Math.random() * (canvas.width - size); var randObj = itemsList[Math.floor(Math.random() * itemsList.length)]; var dropSpeed = 5 + (currentLevel * 1.5); enemies.push({ x: x, y: -size, size: size, text: randObj.text, type: randObj.type, name: randObj.name, speed: dropSpeed }); 
        }
        for (var i = 0; i < enemies.length; i++) { 
            var e = enemies[i]; if(!e) continue; e.y += e.speed; 
            if (player.x < e.x + e.size - 15 && player.x + player.size > e.x + 15 && player.y + 25 < e.y + e.size && player.y + player.size > e.y) { 
                if (e.type === 1) { score += 10; document.getElementById('scoreVal').innerText = score; enemies.splice(i, 1); i--; Sound.score(); } 
                else { gameOver(e.text, e.name); return; } 
            } else if (e.y > canvas.height) { enemies.splice(i, 1); i--; } 
        }
    }
    function drawSorting() { 
        ctx.clearRect(0,0,canvas.width, canvas.height); ctx.fillStyle = 'rgba(0,0,0,0.5)'; ctx.fillRect(0, 0, canvas.width, canvas.height); 
        drawBag(player.x, player.y, player.size); ctx.textAlign = "center"; ctx.textBaseline = "middle"; 
        for (var i=0; i<enemies.length; i++) { var e = enemies[i]; if(!e) continue; ctx.save(); ctx.shadowColor = 'white'; ctx.shadowBlur = 25; ctx.fillStyle = 'white'; ctx.font = "bold " + (e.size * 1.2) + "px sans-serif"; ctx.fillText(e.text, e.x + e.size/2, e.y + e.size/2); ctx.restore(); } 
        drawLevelMessage(); 
    }
    function drawBag(x, y, size) { ctx.save(); ctx.shadowColor = 'rgba(0,0,0,0.3)'; ctx.shadowBlur = 10; ctx.shadowOffsetY = 5; ctx.fillStyle = '#ffffff'; ctx.strokeStyle = '#dddddd'; ctx.lineWidth = 3; ctx.beginPath(); ctx.moveTo(x+size*0.1, y+size*0.25); ctx.quadraticCurveTo(x-size*0.05, y+size*0.6, x+size*0.1, y+size*0.95); ctx.quadraticCurveTo(x+size*0.5, y+size*1.05, x+size*0.9, y+size*0.95); ctx.quadraticCurveTo(x+size*1.05, y+size*0.6, x+size*0.9, y+size*0.25); ctx.closePath(); ctx.fill(); ctx.stroke(); ctx.shadowColor = 'transparent'; ctx.fillStyle = '#ffffff'; ctx.strokeStyle = '#cccccc'; ctx.beginPath(); ctx.arc(x+size*0.35, y+size*0.2, size*0.12, 0, Math.PI*2); ctx.arc(x+size*0.65, y+size*0.2, size*0.12, 0, Math.PI*2); ctx.fill(); ctx.stroke(); ctx.beginPath(); ctx.arc(x+size*0.5, y+size*0.2, size*0.08, 0, Math.PI*2); ctx.fill(); ctx.stroke(); ctx.fillStyle = '#2c3e50'; ctx.textAlign = 'center'; ctx.font = 'bold '+(size*0.2)+'px Arial'; ctx.fillText("ê¹€í¬", x+size/2, y+size*0.6); ctx.fillStyle = '#e74c3c'; ctx.font = 'bold '+(size*0.14)+'px Arial'; ctx.fillText("ì†Œê°ìš©", x+size/2, y+size*0.8); ctx.restore(); }

    // --- [2] íŒŒì´í”„ ê²Œì„ ë¡œì§ ---
    function drawValve(x, y, spin) { 
        ctx.save(); ctx.translate(x, y); 
        if(spin) ctx.rotate(frameCount * 0.1); 
        ctx.beginPath(); ctx.arc(0, 0, 18, 0, Math.PI*2); ctx.fillStyle = '#c0392b'; ctx.fill(); 
        ctx.strokeStyle='#e74c3c'; ctx.lineWidth=4; ctx.stroke(); 
        ctx.strokeStyle = '#922b21'; ctx.lineWidth=3; ctx.beginPath(); ctx.moveTo(0, -18); ctx.lineTo(0, 18); ctx.moveTo(-18, 0); ctx.lineTo(18, 0); ctx.stroke(); 
        ctx.fillStyle = '#ecf0f1'; ctx.beginPath(); ctx.arc(0, 0, 5, 0, Math.PI*2); ctx.fill(); 
        ctx.restore(); 
    }
    
    function drawIncinerator(x, y) { 
        ctx.save(); ctx.translate(x, y); 
        ctx.fillStyle = 'rgba(255,255,255,0.6)'; ctx.beginPath(); ctx.arc(30, -50 - (frameCount%20), 10+(frameCount%10), 0, Math.PI*2); ctx.fill(); 
        ctx.fillStyle = '#2c3e50'; ctx.fillRect(-50, -30, 100, 60); 
        ctx.fillStyle = '#e74c3c'; ctx.fillRect(-50, -30, 100, 10); 
        ctx.fillStyle = '#7f8c8d'; ctx.fillRect(20, -60, 20, 30); 
        ctx.fillStyle = '#f1c40f'; ctx.fillRect(20, -60, 20, 5); 
        ctx.fillStyle = '#ecf0f1'; ctx.fillRect(-40, -10, 15, 20); ctx.fillRect(-15, -10, 15, 20); 
        
        ctx.fillStyle = '#1e272e'; drawRoundRect(ctx, -65, 35, 130, 28, 14); ctx.fill();
        ctx.strokeStyle = '#f1c40f'; ctx.lineWidth = 2; ctx.stroke();
        ctx.fillStyle = '#ffffff'; ctx.font = 'bold 16px Jua'; ctx.textAlign='center'; ctx.textBaseline='middle'; ctx.fillText("ğŸ”¥ìì›í™”ì„¼í„°", 0, 49); 
        ctx.restore(); 
    }
    
    function drawPool(x, y) { 
        ctx.save(); ctx.translate(x, y); 
        ctx.fillStyle = '#ecf0f1'; ctx.fillRect(-60, -30, 120, 60); 
        ctx.fillStyle = '#3498db'; ctx.fillRect(-50, -20, 100, 40); 
        ctx.strokeStyle = '#bdc3c7'; ctx.lineWidth=3; ctx.beginPath(); ctx.moveTo(-35, -25); ctx.lineTo(-35, -5); ctx.moveTo(-25, -25); ctx.lineTo(-25, -5); ctx.stroke(); 
        
        if(isPipeSolved) { 
            var totalTiles = solvedPath.length; var timePerTile = 10; var startDelay = totalTiles * timePerTile + 30; 
            if (solveAnimTimer > startDelay) { 
                ctx.fillStyle = 'rgba(0, 255, 255, 0.4)'; 
                var waterH = Math.min(40, (solveAnimTimer - startDelay) * 1.5); 
                ctx.fillRect(-50, 20 - waterH, 100, waterH); 
            } 
        } 
        ctx.fillStyle = '#1e272e'; drawRoundRect(ctx, -65, 35, 130, 28, 14); ctx.fill();
        ctx.strokeStyle = '#3498db'; ctx.lineWidth = 2; ctx.stroke();
        ctx.fillStyle = '#ffffff'; ctx.font = 'bold 16px Jua'; ctx.textAlign='center'; ctx.textBaseline='middle'; ctx.fillText("ğŸŠìŠ¤í¬ì¸ ì„¼í„°", 0, 49); 
        ctx.restore(); 
    }

    function initPipeLevel() {
        gridCols = 4 + Math.floor((currentLevel-1)/3); gridRows = 5 + Math.floor((currentLevel-1)/2); if(gridCols > 6) gridCols = 6; if(gridRows > 8) gridRows = 8;
        var headerSpace = Math.min(160, screenHeight * 0.25); var footerSpace = Math.min(160, screenHeight * 0.25);
        var availableW = Math.max(100, screenWidth - 20); var availableH = Math.max(100, screenHeight - (headerSpace + footerSpace)); 
        cellSize = Math.max(10, Math.min(availableW / gridCols, availableH / gridRows));
        pipeOffsetX = (screenWidth - (cellSize * gridCols)) / 2; pipeOffsetY = headerSpace + (availableH - (cellSize * gridRows)) / 2; 
        startCol = Math.floor(Math.random() * gridCols); endCol = Math.floor(Math.random() * gridCols); generatePuzzle(); isPipeSolved = false; solveAnimTimer = 0; solvedPath = []; isHinting = false; hintTimer = 0;
    }
    
    function generatePuzzle() {
        grid = []; for(var x=0; x<gridCols; x++) { grid[x] = []; for(var y=0; y<gridRows; y++) { grid[x][y] = { type: 'I', rotation: 0, connected: false, isPath: false }; } }
        var currX = startCol; var currY = 0; var path = [{x:currX, y:currY}]; grid[currX][currY].isPath = true;
        var loop1 = 0;
        while(currY < gridRows - 1 && loop1++ < 200) {
            var possibleMoves = []; possibleMoves.push({dx:0, dy:1}); if(currX > 0 && !isVisited(path, currX-1, currY)) possibleMoves.push({dx:-1, dy:0}); if(currX < gridCols - 1 && !isVisited(path, currX+1, currY)) possibleMoves.push({dx:1, dy:0});
            var move; var wantDir = (endCol > currX) ? 1 : (endCol < currX ? -1 : 0); var r = Math.random();
            if(r < 0.4) { move = {dx:0, dy:1}; } else { var horizontalMoves = possibleMoves.filter(m => m.dy === 0); if(horizontalMoves.length > 0) { var bestMove = horizontalMoves.find(m => m.dx === wantDir); move = bestMove ? bestMove : horizontalMoves[Math.floor(Math.random() * horizontalMoves.length)]; } else { move = {dx:0, dy:1}; } }
            currX += move.dx; currY += move.dy; path.push({x:currX, y:currY}); grid[currX][currY].isPath = true;
        }
        var loop2 = 0;
        while(currX !== endCol && loop2++ < 200) { var dx = (endCol > currX) ? 1 : -1; currX += dx; path.push({x:currX, y:currY}); grid[currX][currY].isPath = true; }
        for(var i=0; i<path.length; i++) { var curr = path[i]; var prev = (i>0) ? path[i-1] : {x:startCol, y:-1}; var next = (i<path.length-1) ? path[i+1] : {x:endCol, y:gridRows}; var fromDir = getDir(curr, prev); var toDir = getDir(curr, next); setPipeType(curr.x, curr.y, fromDir, toDir); }
        for(var x=0; x<gridCols; x++) { for(var y=0; y<gridRows; y++) { if(!grid[x][y].isPath) { grid[x][y].type = Math.random() < 0.5 ? 'I' : 'L'; } grid[x][y].rotation = Math.floor(Math.random() * 4) * 90; } }
    }
    
    function isVisited(path, x, y) { return path.some(p => p.x === x && p.y === y); }
    function getDir(curr, target) { if(target.x < curr.x) return 'left'; if(target.x > curr.x) return 'right'; if(target.y < curr.y) return 'up'; if(target.y > curr.y) return 'down'; return 'none'; }
    function setPipeType(x, y, d1, d2) { var dirs = [d1, d2].sort(); var type = 'L'; if((dirs[0]==='left' && dirs[1]==='right') || (dirs[0]==='down' && dirs[1]==='up')) type = 'I'; grid[x][y].type = type; }
    
    function checkConnection() {
        for(var x=0; x<gridCols; x++) for(var y=0; y<gridRows; y++) grid[x][y].connected = false;
        if(!isOpen(startCol, 0, 'up')) return null; 
        var queue = [{x:startCol, y:0, path:[{x:startCol, y:0}]}]; grid[startCol][0].connected = true;
        var loop3 = 0;
        while(queue.length > 0 && loop3++ < 1000) {
            var curr = queue.shift();
            if(curr.x === endCol && curr.y === gridRows - 1) { if(isOpen(curr.x, curr.y, 'down')) return curr.path; }
            var dirs = [{dx:0, dy:-1, dir:'up', opp:'down'}, {dx:0, dy:1, dir:'down', opp:'up'}, {dx:-1, dy:0, dir:'left', opp:'right'}, {dx:1, dy:0, dir:'right', opp:'left'}];
            for(var d of dirs) { var nx = curr.x + d.dx; var ny = curr.y + d.dy; if(nx>=0 && nx<gridCols && ny>=0 && ny<gridRows) { if(!grid[nx][ny].connected && isOpen(curr.x, curr.y, d.dir) && isOpen(nx, ny, d.opp)) { grid[nx][ny].connected = true; var newPath = curr.path.slice(); newPath.push({x:nx, y:ny}); queue.push({x:nx, y:ny, path:newPath}); } } }
        } return null;
    }
    
    function isOpen(x, y, dir) { var t = grid[x][y]; var rot = t.rotation % 360; var c = {t:false, r:false, b:false, l:false}; if (t.type === 'I') { if (rot === 0 || rot === 180) { c.l=true; c.r=true; } else { c.t=true; c.b=true; } } else { if (rot === 0) { c.r=true; c.b=true; } else if (rot === 90) { c.b=true; c.l=true; } else if (rot === 180) { c.l=true; c.t=true; } else if (rot === 270) { c.t=true; c.r=true; } } if(dir==='up') return c.t; if(dir==='right') return c.r; if(dir==='down') return c.b; if(dir==='left') return c.l; return false; }
    
    function updatePipePuzzle() {
        if(isPipeSolved) { solveAnimTimer++; var totalTiles = solvedPath.length > 0 ? solvedPath.length : gridRows; if (solveAnimTimer > totalTiles * 10 + 60 || solveAnimTimer > 180) levelUpPipeGame(); return; }
        frameCount++; if (frameCount % 60 === 0) { gameTimeLeft--; document.getElementById('timerVal').innerText = gameTimeLeft; if (gameTimeLeft <= 0) gameOver("ì‹œê°„ ì´ˆê³¼!", "ì˜¨ìˆ˜ ê³µê¸‰ ì‹¤íŒ¨"); }
        var path = checkConnection(); if(path) { isPipeSolved = true; solvedPath = path; solveAnimTimer = 0; Sound.score(); }
        if(isHinting) { hintTimer--; if(hintTimer <= 0) isHinting = false; }
    }
    
    function levelUpPipeGame() { 
        score += 1000; currentLevel++; 
        if(currentLevel > 38) { gameClear(); return; } 
        var reduction = Math.floor((currentLevel - 1) / 10) * 5; gameTimeLeft = Math.max(10, 30 - reduction); showLevelMsg(); 
        var lvlEl = document.getElementById('lvlVal'); if(lvlEl) lvlEl.innerText = currentLevel;
        var timerEl = document.getElementById('timerVal'); if(timerEl) timerEl.innerText = gameTimeLeft;
        initPipeLevel(); 
    }
    
    function drawConnectors(x1, y1, x2, y2, isStart) { 
        var thick = Math.max(6, cellSize * 0.3); 
        ctx.lineWidth = thick; ctx.lineCap = 'round'; ctx.strokeStyle = '#7f8c8d'; 
        var midY = (y1 + y2) / 2; ctx.beginPath(); ctx.moveTo(x1, y1); ctx.lineTo(x1, midY); ctx.lineTo(x2, midY); ctx.lineTo(x2, y2); ctx.stroke(); 
        
        if(isPipeSolved) { 
            ctx.strokeStyle = '#3498db'; ctx.lineWidth = thick * 0.7; var shouldDraw = false; var totalTiles = solvedPath.length; var timePerTile = 10; 
            if(isStart) { if(solveAnimTimer > 0) shouldDraw = true; } else { if(solveAnimTimer > totalTiles * timePerTile) shouldDraw = true; } 
            if(shouldDraw) { ctx.beginPath(); ctx.moveTo(x1, y1); ctx.lineTo(x1, midY); ctx.lineTo(x2, midY); ctx.lineTo(x2, y2); ctx.stroke(); } 
        } 
    }
    
    function drawPipePuzzle() {
        ctx.clearRect(0,0,canvas.width, canvas.height); 
        ctx.fillStyle = 'rgba(0,0,0,0.2)'; ctx.fillRect(0, 0, canvas.width, canvas.height);
        
        ctx.fillStyle = 'rgba(0, 0, 0, 0.4)';
        drawRoundRect(ctx, pipeOffsetX - 15, pipeOffsetY - 15, gridCols * cellSize + 30, gridRows * cellSize + 30, 15);
        ctx.fill();

        var startX = pipeOffsetX + startCol*cellSize + cellSize/2; var endX = pipeOffsetX + endCol*cellSize + cellSize/2;
        var topY = pipeOffsetY; var bottomY = pipeOffsetY + gridRows*cellSize;
        var incineratorY = pipeOffsetY - 90; var poolY = bottomY + 60; 
        
        for(var x=0; x<gridCols; x++) for(var y=0; y<gridRows; y++) drawTile(x, y);

        drawConnectors(screenWidth / 2, incineratorY + 50, startX, topY, true);
        drawConnectors(endX, bottomY, screenWidth / 2, poolY - 30, false);
        drawValve(startX, topY, isPipeSolved); drawValve(endX, bottomY, isPipeSolved);
        
        drawIncinerator(screenWidth / 2, incineratorY); 
        drawPool(screenWidth / 2, poolY); 
        
        ctx.fillStyle = (frameCount % 60 < 30) ? '#ffeb3b' : '#ff9800'; ctx.font = '30px Jua'; ctx.textAlign='center'; 
        ctx.fillText("â¬‡ï¸", startX, topY - 15); ctx.fillText("â¬‡ï¸", endX, bottomY + 30);
        
        drawLevelMessage();
    }
    
    function drawTile(gx, gy) { 
        var tile = grid[gx][gy]; var cx = pipeOffsetX + gx*cellSize + cellSize/2; var cy = pipeOffsetY + gy*cellSize + cellSize/2; 
        var size = Math.max(1, cellSize * 0.95); var thick = Math.max(1, cellSize * 0.35); 
        ctx.save(); ctx.translate(cx, cy); ctx.rotate(tile.rotation * Math.PI / 180); 
        
        try {
            var pipeGrad = ctx.createLinearGradient(-size/2, -thick/2, -size/2, thick/2);
            pipeGrad.addColorStop(0, '#7f8c8d'); pipeGrad.addColorStop(0.5, '#ecf0f1'); pipeGrad.addColorStop(1, '#7f8c8d');
            ctx.fillStyle = pipeGrad;
        } catch(e) { ctx.fillStyle = '#95a5a6'; }
        
        if(isHinting && tile.isPath) { ctx.shadowColor = "yellow"; ctx.shadowBlur = 20; } 
        if(tile.type==='I') ctx.fillRect(-size/2, -thick/2, size, thick); else { ctx.beginPath(); ctx.moveTo(thick/2, size/2); ctx.lineTo(-thick/2, size/2); ctx.lineTo(-thick/2, -thick/2); ctx.lineTo(size/2, -thick/2); ctx.lineTo(size/2, thick/2); ctx.lineTo(thick/2, thick/2); ctx.closePath(); ctx.fill(); } 
        
        ctx.fillStyle = '#34495e'; 
        if(tile.type==='I') { ctx.fillRect(-size/2-2, -thick/2-2, 6, thick+4); ctx.fillRect(size/2-4, -thick/2-2, 6, thick+4); } 
        else { ctx.fillRect(-thick/2-2, -thick/2-2, thick+4, 6); ctx.fillRect(-thick/2-2, size/2-4, thick+4, 6); ctx.fillRect(size/2-4, -thick/2-2, 6, thick+4); } 
        
        if(tile.connected && isPipeSolved) { 
            var pathIndex = -1; for(var i=0; i<solvedPath.length; i++) { if(solvedPath[i].x === gx && solvedPath[i].y === gy) { pathIndex = i; break; } } 
            if(pathIndex !== -1) { 
                var timePerTile = 10; var startTime = pathIndex * timePerTile; var endTime = (pathIndex + 1) * timePerTile; var progress = Math.min(1, Math.max(0, (solveAnimTimer - startTime) / (endTime - startTime))); 
                if(progress > 0) { 
                    try {
                        var waterGrad = ctx.createLinearGradient(-size/2, -thick/2, -size/2, thick/2);
                        waterGrad.addColorStop(0, '#2980b9'); waterGrad.addColorStop(0.5, '#6dd5ed'); waterGrad.addColorStop(1, '#2980b9');
                        ctx.fillStyle = waterGrad;
                        ctx.shadowColor = '#00ffff'; ctx.shadowBlur = 10; 
                    } catch(e) { ctx.fillStyle = '#3498db'; }
                    var wThick = thick * 0.6; 
                    if(tile.type==='I') { ctx.fillRect(-size/2, -wThick/2, size * progress, wThick); } else { ctx.beginPath(); var w = wThick/2; var len = size/2 + w; var currentLen = len * progress; if (currentLen <= size/2 - w) { ctx.moveTo(-w, -w); ctx.lineTo(-w, -w + currentLen); ctx.lineTo(w, -w + currentLen); ctx.lineTo(w, -w); } else { ctx.moveTo(-w, -w); ctx.lineTo(-w, size/2); ctx.lineTo(w, size/2); ctx.lineTo(w, w); ctx.lineTo(-w + currentLen, w); ctx.lineTo(-w + currentLen, -w); } ctx.fill(); } 
                } 
            } 
        } 
        ctx.restore(); ctx.strokeStyle = 'rgba(255,255,255,0.1)'; ctx.lineWidth = 1; ctx.strokeRect(pipeOffsetX + gx*cellSize, pipeOffsetY + gy*cellSize, cellSize, cellSize); 
    }

    // --- [3] ì˜¤ì—¼ë¬¼ì§ˆ ì œë¡œ ë¯¸ì…˜ (ìŠˆíŒ…) ë¡œì§ ---
    function updateShooter() {
        if (inputLeft && player.x > 0) player.x -= player.speed; 
        if (inputRight && player.x < canvas.width - player.size) player.x += player.speed;
        if (player.x < 0) player.x = 0; if (player.x > canvas.width - player.size) player.x = canvas.width - player.size;

        var calculatedLevel = Math.floor(score / 200) + 1; 
        if (calculatedLevel > currentLevel) { 
            currentLevel = calculatedLevel; 
            showLevelMsg(); 
            var lvlEl = document.getElementById('lvlVal'); 
            if(lvlEl) lvlEl.innerText = currentLevel;
        }

        if (score >= nextHealScore) {
            if (pollutionLevel > 0) {
                pollutionLevel = Math.max(0, pollutionLevel - 20);
                document.getElementById('pollutionVal').innerText = pollutionLevel;
                createFloatingText(screenWidth/2, screenHeight/2, "â¤ï¸ì •í™” ì™„ë£Œ!", "#2ecc71");
                Sound.score();
            }
            nextHealScore += 1000;
        }

        frameCount++;
        
        if (frameCount % 480 === 0) { spawnGate(); }

        for (var i = gates.length - 1; i >= 0; i--) {
            var g = gates[i]; 
            g.y += 3;
            g.anim = (g.anim || 0) + 0.1; 
            
            if (player.x < g.x + g.w && player.x + player.size > g.x && player.y < g.y + g.h && player.y + player.size > g.y) {
                applyGateEffect(g.effect); g.dead = true;
            } else if (g.y > canvas.height) { g.dead = true; }
        }
        gates = gates.filter(g => !g.dead);

        if (frameCount % 10 === 0) { 
            Sound.shoot(); 
            var laserWidth = 6; var laserColor = '#00ffff'; 
            if (currentLevel >= 3) { laserColor = '#f1c40f'; laserWidth = 8; }
            if (currentLevel >= 6) { laserColor = '#9b59b6'; laserWidth = 10; }
            var spreadAngle = 0.08;
            var startX = player.x + player.size/2; var startY = player.y;
            var totalAngle = (laserCount - 1) * spreadAngle; var startAngle = -Math.PI/2 - totalAngle / 2;
            
            for(var k=0; k<laserCount; k++) {
                var currentAngle = startAngle + (k * spreadAngle);
                var vx = Math.cos(currentAngle) * 25; var vy = Math.sin(currentAngle) * 25;
                bullets.push({ x: startX, y: startY, vx: vx, vy: vy, w: laserWidth, h: 60, angle: currentAngle + Math.PI/2, color: laserColor, type: 'laser', life: 60 });
            }
        }

        if (frameCount % 30 === 0 && missileCount > 0) {
            for(var m=0; m<missileCount; m++) {
                var startX = player.x + player.size/2; var startY = player.y;
                var rx = (Math.random() - 0.5) * 15;
                var ry = -5 - (Math.random() * 5);
                bullets.push({ x: startX, y: startY, vx: rx, vy: ry, size: 15, speed: 8, color: '#ff6b81', type: 'missile', target: null, life: 60 });
            }
        }

        var totalWeapons = laserCount + missileCount; 
        
        var baseSpawnRate = 80 - (currentLevel * 1.5) - (totalWeapons * 4);
        var spawnRate = Math.max(20, Math.floor(baseSpawnRate / 1.2)); 
        
        if (frameCount % spawnRate === 0) {
            var pType = pollutantTypes[Math.floor(Math.random() * pollutantTypes.length)];
            var size = 60; var x = Math.random() * (canvas.width - size);
            
            var hp = Math.min(10, 1 + Math.floor((currentLevel - 1) / 2));
            var dropSpeed = Math.min(4.5, 1.5 + (currentLevel * 0.1) + (Math.random() * 1.0));
            var swaySpeed = (currentLevel >= 2) ? (Math.random() - 0.5) * Math.min(3, currentLevel * 0.3) : 0;

            pollutants.push({ 
                x: x, y: -size, size: size, 
                text: pType.text, color: pType.color, name: pType.name, 
                speed: dropSpeed, hp: hp, maxHp: hp, sway: swaySpeed, startX: x, frameOffset: Math.random()*100, hitTimer: 0 
            });
        }

        for(var i = 0; i < shooterParticles.length; i++) {
            var p = shooterParticles[i]; p.x += p.vx; p.y += p.vy; p.life -= 0.05;
            if(p.life <= 0) p.dead = true;
        }
        if(shooterParticles.length > 80) shooterParticles.splice(0, 20); 
        shooterParticles = shooterParticles.filter(p => !p.dead);

        for(var i = 0; i < floatingTexts.length; i++) {
            var ft = floatingTexts[i]; ft.y -= 1; ft.life -= 0.02;
            if(ft.life <= 0) ft.dead = true;
        }
        floatingTexts = floatingTexts.filter(ft => !ft.dead);

        for (var i = 0; i < bullets.length; i++) {
            var b = bullets[i]; 
            if (b.type === 'missile') {
                b.life--; if (b.life <= 0) { createExplosion(b.x, b.y, b.color); b.dead = true; continue; }
                
                if (!b.target || b.target.dead || pollutants.indexOf(b.target) === -1) { b.target = findNearestPollutant(b); }
                if (b.target) {
                    var dx = b.target.x + b.target.size/2 - b.x; var dy = b.target.y + b.target.size/2 - b.y;
                    var dist = Math.sqrt(dx*dx + dy*dy);
                    b.vx += (dx/dist) * 1.5; b.vy += (dy/dist) * 1.5;
                    var vel = Math.sqrt(b.vx*b.vx + b.vy*b.vy);
                    if (vel > b.speed) { b.vx = (b.vx/vel)*b.speed; b.vy = (b.vy/vel)*b.speed; }
                    b.angle = Math.atan2(b.vy, b.vx) + Math.PI/2;
                }
            } else if (b.type === 'laser') {
                b.life--; if (b.life <= 0) { b.dead = true; continue; }
            }
            
            b.x += b.vx; b.y += b.vy;
            if (b.y + b.h < 0 || b.x < 0 || b.x > canvas.width || b.y > canvas.height) { b.dead = true; continue; }

            var hit = false;
            for (var j = 0; j < pollutants.length; j++) {
                var p = pollutants[j];
                if(p.dead) continue;
                var dx = b.x - (p.x + p.size/2); var dy = b.y - (p.y + p.size/2);
                var dist = Math.sqrt(dx*dx + dy*dy);
                if (dist < p.size/2 + 20) {
                    p.hp -= 1;
                    if (p.hp <= 0) {
                        score += 10; document.getElementById('scoreVal').innerText = score;
                        createExplosion(p.x + p.size/2, p.y + p.size/2, p.color);
                        p.dead = true; 
                    } else {
                        p.hitTimer = 5; 
                        Sound.click();
                    }
                    hit = true; break; 
                }
            }
            if (hit) b.dead = true;
        }
        
        for (var i = 0; i < pollutants.length; i++) {
            var p = pollutants[i]; 
            if(p.dead) continue;
            
            p.y += p.speed;
            if (p.sway !== 0) {
                p.x = p.startX + Math.sin((frameCount + p.frameOffset) * 0.05) * (p.sway * 15);
                if (p.x < 0) p.x = 0;
                if (p.x > canvas.width - p.size) p.x = canvas.width - p.size;
            }

            if (p.y > canvas.height) {
                pollutionLevel += 10; document.getElementById('pollutionVal').innerText = pollutionLevel;
                p.dead = true;
                if (pollutionLevel >= 100) { gameOver("ëŒ€ê¸° ì˜¤ì—¼ ê²½ë³´!", "ì˜¤ì—¼ í—ˆìš©ì¹˜ ì´ˆê³¼!"); return; }
            }
        }

        bullets = bullets.filter(b => !b.dead);
        pollutants = pollutants.filter(p => !p.dead);
    }

    function findNearestPollutant(missile) {
        var minDst = 9999; var target = null;
        for(var p of pollutants) {
            if(p.dead) continue;
            var dx = p.x - missile.x; var dy = p.y - missile.y;
            var dst = Math.sqrt(dx*dx + dy*dy);
            if (dst < minDst && p.y < canvas.height) { minDst = dst; target = p; }
        }
        return target;
    }

    function spawnGate() {
        var types = [
            { text: "âœ¨ ë¬´ê¸° +1", color: "#3498db", effect: "plus1", border: "#2980b9" },
            { text: "ğŸ”¥ ë¬´ê¸° x2", color: "#9b59b6", effect: "double", border: "#8e44ad" },
            { text: "âš ï¸ ë¬´ê¸° -1", color: "#e74c3c", effect: "minus1", border: "#c0392b" },
            { text: "â˜ ï¸ ë¬´ê¸° Ã·2", color: "#c0392b", effect: "half", border: "#922b21" }
        ];
        var badProb = Math.min(0.5, 0.1 + (currentLevel * 0.03));
        var type; if(Math.random() > badProb) { type = types[Math.floor(Math.random() * 2)]; } else { type = types[Math.floor(Math.random() * 2) + 2]; }
        
        gates.push({ x: Math.random() * (canvas.width - 130), y: -100, w: 130, h: 60, text: type.text, color: type.color, effect: type.effect, border: type.border, anim: Math.random() * Math.PI * 2 });
    }

    function applyGateEffect(effect) {
        var currentTotal = laserCount + missileCount; var nextTotal = currentTotal;
        if (effect === "plus1") nextTotal++; else if (effect === "double") nextTotal *= 2; else if (effect === "minus1") nextTotal--; else if (effect === "half") nextTotal = Math.floor(nextTotal / 2);
        nextTotal = Math.max(1, Math.min(8, nextTotal)); 
        
        if (nextTotal <= 3) { 
            laserCount = nextTotal; missileCount = 0; 
        } else { 
            laserCount = 3; missileCount = nextTotal - 3; 
        }
        
        var diff = nextTotal - currentTotal; var msg = diff >= 0 ? "POWER UP!" : "DOWN..."; var color = diff >= 0 ? "#2ecc71" : "#e74c3c";
        createFloatingText(player.x, player.y - 50, msg, color);
        if (diff >= 0) Sound.levelUp(); else Sound.error(); 
    }

    function createExplosion(x, y, color) { 
        Sound.explosion(); 
        shooterParticles.push({ type: 'wave', x: x, y: y, size: 10, life: 1.0, color: color });
        for(var i=0; i<10; i++) { 
            shooterParticles.push({ type: 'spark', x: x, y: y, vx: (Math.random() - 0.5) * 15, vy: (Math.random() - 0.5) * 15, color: Math.random() < 0.5 ? color : '#ffffff', life: 1.0, size: Math.random() * 5 + 2 }); 
        } 
    }
    function createFloatingText(x, y, text, color) { floatingTexts.push({ x: x, y: y, text: text, color: color, life: 1.0 }); }

    function drawShooter() {
        ctx.clearRect(0,0,canvas.width, canvas.height);
        ctx.fillStyle = 'rgba(0, 0, 0, 0.3)'; ctx.fillRect(0, 0, canvas.width, canvas.height);
        drawCoolTurret(player.x, player.y, player.size);

        for(var g of gates) {
            ctx.save(); 
            var boxY = g.y + Math.sin(g.anim) * 5; 
            ctx.translate(g.x + g.w/2, boxY + g.h/2);
            
            ctx.shadowBlur = 15; 
            ctx.shadowColor = g.color; 
            
            var grad = ctx.createLinearGradient(-g.w/2, -g.h/2, g.w/2, g.h/2);
            grad.addColorStop(0, 'rgba(255, 255, 255, 0.9)');
            grad.addColorStop(0.3, g.color);
            grad.addColorStop(1, g.border);
            
            ctx.fillStyle = grad;
            drawRoundRect(ctx, -g.w/2, -g.h/2, g.w, g.h, 20); 
            ctx.fill();
            
            ctx.strokeStyle = "rgba(255,255,255,0.8)";
            ctx.lineWidth = 3;
            ctx.stroke();
            
            ctx.shadowBlur = 2;
            ctx.shadowColor = 'rgba(0,0,0,0.5)';
            ctx.fillStyle = "white"; 
            ctx.font = "bold 20px Jua"; 
            ctx.textAlign = "center"; 
            ctx.textBaseline = "middle"; 
            ctx.fillText(g.text, 0, 0);
            ctx.restore();
        }

        for(var b of bullets) {
            ctx.save(); ctx.translate(b.x, b.y); ctx.rotate(b.angle); 
            if (b.type === 'laser') {
                ctx.globalAlpha = b.life / 60; 
                ctx.shadowBlur = 10; ctx.shadowColor = b.color; ctx.fillStyle = b.color; ctx.fillRect(-b.w/2, 0, b.w, b.h); 
            } else {
                ctx.shadowBlur = 10; ctx.shadowColor = '#ff6b81'; ctx.fillStyle = '#ff6b81';
                ctx.beginPath(); ctx.moveTo(0, -10); ctx.lineTo(-5, 5); ctx.lineTo(0, 2); ctx.lineTo(5, 5); ctx.fill();
                ctx.beginPath(); ctx.fillStyle='orange'; ctx.arc(0, 6, 3 + Math.random()*2, 0, Math.PI*2); ctx.fill();
            }
            ctx.restore();
        }
        ctx.shadowBlur = 0; ctx.globalAlpha = 1.0;

        ctx.globalCompositeOperation = 'lighter'; 
        for(var part of shooterParticles) { 
            ctx.globalAlpha = part.life; 
            if (part.type === 'wave') {
                ctx.strokeStyle = part.color; ctx.lineWidth = 5 * part.life;
                ctx.beginPath(); ctx.arc(part.x, part.y, part.size + (1.0 - part.life) * 50, 0, Math.PI*2); ctx.stroke();
            } else {
                ctx.fillStyle = part.color; ctx.beginPath(); ctx.arc(part.x, part.y, part.size, 0, Math.PI*2); ctx.fill(); 
            }
        }
        ctx.globalCompositeOperation = 'source-over'; ctx.globalAlpha = 1.0;

        for(var ft of floatingTexts) { ctx.globalAlpha = ft.life; ctx.fillStyle = ft.color; ctx.font = "bold 40px Jua"; ctx.textAlign = "center"; ctx.shadowColor = "black"; ctx.shadowBlur = 5; ctx.fillText(ft.text, ft.x, ft.y); ctx.shadowBlur = 0; }
        ctx.globalAlpha = 1.0;

        for(var p of pollutants) {
            ctx.save();
            if (p.hitTimer > 0) {
                p.hitTimer--;
                ctx.globalAlpha = 0.5; ctx.fillStyle = 'white';
                ctx.beginPath(); ctx.arc(p.x + p.size/2, p.y + p.size/2, p.size/2, 0, Math.PI*2); ctx.fill();
                ctx.globalAlpha = 1.0;
            }
            ctx.font = "bold " + (p.size * 0.6) + "px sans-serif"; ctx.fillStyle = p.color; ctx.shadowBlur = 5; ctx.shadowColor = p.color; ctx.fillText(p.text, p.x + p.size/2, p.y + p.size/2);
            ctx.font = "12px sans-serif"; ctx.fillStyle = "white"; ctx.shadowBlur = 0; ctx.fillText(p.name, p.x + p.size/2, p.y + p.size/2 + 20);
            
            if (p.maxHp > 1) {
                var barW = p.size * 0.8; var barH = 6;
                ctx.fillStyle = "rgba(0,0,0,0.5)"; ctx.fillRect(p.x + p.size*0.1, p.y - 10, barW, barH);
                ctx.fillStyle = "#2ecc71"; ctx.fillRect(p.x + p.size*0.1, p.y - 10, barW * (p.hp / p.maxHp), barH);
            }
            ctx.restore();
        }
        drawLevelMessage();
    }

    function drawCoolTurret(x, y, size) {
        var cx = x + size/2; var cy = y + size/2;
        ctx.save(); ctx.translate(cx, cy);
        var coreColor = '#00ffff'; if (currentLevel >= 3) coreColor = '#f1c40f'; if (currentLevel >= 6) coreColor = '#9b59b6'; if (currentLevel >= 10) coreColor = '#e74c3c';
        var baseGrad = ctx.createLinearGradient(-30, 0, 30, 0); baseGrad.addColorStop(0, '#434343'); baseGrad.addColorStop(0.5, '#868f96'); baseGrad.addColorStop(1, '#434343'); ctx.fillStyle = baseGrad; ctx.beginPath(); ctx.arc(0, 20, 30, 0, Math.PI, true); ctx.fill();
        var barrelGrad = ctx.createLinearGradient(-15, 0, 15, 0); barrelGrad.addColorStop(0, '#243949'); barrelGrad.addColorStop(0.5, '#517fa4'); barrelGrad.addColorStop(1, '#243949'); ctx.fillStyle = barrelGrad; ctx.fillRect(-12, -30, 24, 50);
        ctx.shadowBlur = 20; ctx.shadowColor = coreColor; ctx.fillStyle = coreColor; ctx.beginPath(); ctx.arc(0, 0, 8, 0, Math.PI*2); ctx.fill();
        ctx.strokeStyle = coreColor; ctx.lineWidth = 2; ctx.beginPath(); ctx.ellipse(0, -30, 12, 4, 0, 0, Math.PI*2); ctx.stroke();
        if (missileCount > 0) { ctx.fillStyle = '#ff6b81'; ctx.fillRect(-35, 0, 10, 20); ctx.fillRect(25, 0, 10, 20); }
        ctx.restore();
    }

    // --- [4] ì—ì½” ì •í™” ë§í¬ (ì‚¬ì²œì„±) ---
    function initSichuanLayout() {
        var marginX = 10; var headerSpace = 150; var footerSpace = 100;
        var availableW = Math.max(100, screenWidth - (marginX*2)); var availableH = Math.max(100, screenHeight - (headerSpace + footerSpace));
        var maxW = availableW / scCols; var maxH = availableH / scRows;
        scTileSize = Math.max(20, Math.min(maxW, maxH) * 0.95);
        scOffsetX = (screenWidth - (scTileSize * scCols)) / 2;
        scOffsetY = Math.max(80, headerSpace + (availableH - (scTileSize * scRows)) / 2);
    }

    function initSichuanLevel() {
        var deck = [];
        for(var i=0; i<4; i++) {
            for(var pair of scPairs) {
                deck.push({ id: pair.id, type: 'p', text: pair.p, color: pair.color }); 
                deck.push({ id: pair.id, type: 'c', text: pair.c, color: pair.color }); 
            }
        }
        deck.sort(() => Math.random() - 0.5);

        scGrid = [];
        for(var x=0; x<scCols; x++) {
            scGrid[x] = [];
            for(var y=0; y<scRows; y++) {
                scGrid[x][y] = deck.pop();
            }
        }
        scSelected = null; scPath = null; scHintMatch = null; scRemoving = null;
        if (!hasPossibleScMatch()) doScShuffle();
    }

    function isScEmpty(x, y) {
        if (x < 0 || x >= scCols || y < 0 || y >= scRows) return true; 
        return scGrid[x][y] === null;
    }

    function getScReachable(x, y) {
        var pts = [{x:x, y:y}];
        for(var i=y-1; i>=-1; i--) { if(isScEmpty(x,i)) pts.push({x:x,y:i}); else break; } 
        for(var i=y+1; i<=scRows; i++) { if(isScEmpty(x,i)) pts.push({x:x,y:i}); else break; } 
        for(var i=x-1; i>=-1; i--) { if(isScEmpty(i,y)) pts.push({x:i,y:y}); else break; } 
        for(var i=x+1; i<=scCols; i++) { if(isScEmpty(i,y)) pts.push({x:i,y:y}); else break; } 
        return pts;
    }

    function isScClearX(y, x1, x2) {
        var minX = Math.min(x1, x2); var maxX = Math.max(x1, x2);
        for(var x = minX + 1; x < maxX; x++) { if(!isScEmpty(x, y)) return false; }
        return true;
    }

    function isScClearY(x, y1, y2) {
        var minY = Math.min(y1, y2); var maxY = Math.max(y1, y2);
        for(var y = minY + 1; y < maxY; y++) { if(!isScEmpty(x, y)) return false; }
        return true;
    }

    function checkScMatch(x1, y1, x2, y2) {
        var t1 = scGrid[x1][y1]; var t2 = scGrid[x2][y2];
        if (!t1 || !t2) return null;
        if (t1.id !== t2.id || t1.type === t2.type) return null; 

        var p1 = {x:x1, y:y1}; var p2 = {x:x2, y:y2};
        var r1 = getScReachable(p1.x, p1.y); var r2 = getScReachable(p2.x, p2.y);
        
        for(var l1 of r1) {
            for(var l2 of r2) {
                if (l1.x === l2.x && isScClearY(l1.x, l1.y, l2.y)) return [p1, l1, l2, p2];
                if (l1.y === l2.y && isScClearX(l1.y, l1.x, l2.x)) return [p1, l1, l2, p2];
            }
        }
        return null;
    }

    function hasPossibleScMatch() {
        for(var x1=0; x1<scCols; x1++) {
            for(var y1=0; y1<scRows; y1++) {
                if(!scGrid[x1][y1]) continue;
                for(var x2=0; x2<scCols; x2++) {
                    for(var y2=0; y2<scRows; y2++) {
                        if(!scGrid[x2][y2] || (x1===x2 && y1===y2)) continue;
                        var path = checkScMatch(x1, y1, x2, y2);
                        if(path) return [ {x:x1,y:y1}, path, {x:x2,y:y2} ];
                    }
                }
            }
        }
        return null;
    }

    function doScShuffle() {
        var tiles = [];
        for(var x=0; x<scCols; x++) {
            for(var y=0; y<scRows; y++) {
                if(scGrid[x][y]) tiles.push(scGrid[x][y]);
            }
        }
        if(tiles.length === 0) return;
        
        tiles.sort(() => Math.random() - 0.5);
        var idx = 0;
        for(var x=0; x<scCols; x++) {
            for(var y=0; y<scRows; y++) {
                if(scGrid[x][y] !== null) scGrid[x][y] = tiles[idx++];
            }
        }
        if(!hasPossibleScMatch()) doScShuffle(); 
        
        scHintMatch = null;
        createFloatingText(screenWidth/2, screenHeight/2, "ğŸ”„ ì„ê¸°!", "#f1c40f");
    }

    function checkScWin() {
        for(var x=0; x<scCols; x++) {
            for(var y=0; y<scRows; y++) {
                if(scGrid[x][y]) return false;
            }
        }
        return true;
    }

    function updateSichuan() {
        frameCount++;
        if (frameCount % 60 === 0) {
            gameTimeLeft--; 
            var tVal = document.getElementById('timerVal');
            if(tVal) tVal.innerText = gameTimeLeft;
            if (gameTimeLeft <= 0) gameOver("ì‹œê°„ ì´ˆê³¼!", "ì •í™” ì‹¤íŒ¨");
        }
        
        for(var i = 0; i < shooterParticles.length; i++) {
            var p = shooterParticles[i]; p.x += p.vx; p.y += p.vy; p.life -= 0.05;
            if(p.life <= 0) p.dead = true;
        }
        shooterParticles = shooterParticles.filter(p => !p.dead);
        
        for(var i = 0; i < floatingTexts.length; i++) {
            var ft = floatingTexts[i]; ft.y -= 1; ft.life -= 0.02;
            if(ft.life <= 0) ft.dead = true;
        }
        floatingTexts = floatingTexts.filter(ft => !ft.dead);

        if (scPathTimer > 0) {
            scPathTimer--;
            if (scPathTimer === 0) {
                scPath = null;
                if (scRemoving) {
                    var t1 = scRemoving[0]; var t2 = scRemoving[1];
                    if (scGrid[t1.x] && scGrid[t1.x][t1.y]) {
                        createExplosion(scOffsetX + t1.x*scTileSize + scTileSize/2, scOffsetY + t1.y*scTileSize + scTileSize/2, scGrid[t1.x][t1.y].color);
                        createExplosion(scOffsetX + t2.x*scTileSize + scTileSize/2, scOffsetY + t2.y*scTileSize + scTileSize/2, scGrid[t2.x][t2.y].color);
                        scGrid[t1.x][t1.y] = null;
                        scGrid[t2.x][t2.y] = null;
                    }
                    scRemoving = null;
                    score += 50; 
                    var scoreEl = document.getElementById('scoreVal');
                    if (scoreEl) scoreEl.innerText = score;
                }
                
                if(checkScWin()) {
                    score += 500; currentLevel++; 
                    gameTimeLeft = Math.max(15, 65 - (currentLevel * 5)); 
                    
                    var lvlEl = document.getElementById('lvlVal'); if(lvlEl) lvlEl.innerText = currentLevel;
                    var timerEl = document.getElementById('timerVal'); if(timerEl) timerEl.innerText = gameTimeLeft;
                    var scoreEl2 = document.getElementById('scoreVal'); if(scoreEl2) scoreEl2.innerText = score;

                    showLevelMsg(); initSichuanLevel();
                } else if(!hasPossibleScMatch()) {
                    doScShuffle();
                }
            }
        }
        if (isHinting) { hintTimer--; if(hintTimer <= 0) { isHinting = false; scHintMatch = null; } }
    }

    function drawTileText(text, cx, cy) {
        var lines = text.split('\n');
        if (lines.length === 1) {
            var ratio = text.length > 4 ? 0.18 : 0.22;
            ctx.font = "bold " + (scTileSize * ratio) + "px Jua";
            ctx.fillText(text, cx, cy);
        } else {
            ctx.font = "bold " + (scTileSize * 0.2) + "px Jua";
            ctx.fillText(lines[0], cx, cy - scTileSize * 0.12);
            ctx.font = "bold " + (scTileSize * 0.14) + "px Jua";
            ctx.fillText(lines[1], cx, cy + scTileSize * 0.18);
        }
    }

    function drawSichuan() {
        ctx.clearRect(0,0,canvas.width, canvas.height); 
        ctx.fillStyle = 'rgba(0,0,0,0.3)'; ctx.fillRect(0, 0, canvas.width, canvas.height);
        
        for(var x=0; x<scCols; x++) {
            for(var y=0; y<scRows; y++) {
                var t = scGrid[x][y];
                if(!t) continue;

                var tx = scOffsetX + x*scTileSize;
                var ty = scOffsetY + y*scTileSize;
                var margin = 3;
                var tw = scTileSize - margin*2;
                var th = scTileSize - margin*2;
                
                ctx.save();
                ctx.translate(tx + margin, ty + margin);
                
                ctx.fillStyle = '#bdc3c7';
                drawRoundRect(ctx, 0, 4, tw, th, 8);
                ctx.fill();

                ctx.fillStyle = '#ffffff';
                drawRoundRect(ctx, 0, 0, tw, th, 8);
                ctx.fill();

                ctx.globalAlpha = 0.15;
                ctx.fillStyle = t.color;
                drawRoundRect(ctx, 0, 0, tw, th, 8);
                ctx.fill();
                ctx.globalAlpha = 1.0;

                ctx.strokeStyle = t.color;
                ctx.lineWidth = 3;
                ctx.stroke();

                if (scSelected && scSelected.x === x && scSelected.y === y) {
                    ctx.fillStyle = 'rgba(241, 196, 15, 0.4)';
                    drawRoundRect(ctx, 0, 0, tw, th, 8);
                    ctx.fill();
                    ctx.strokeStyle = '#f1c40f'; ctx.lineWidth = 5;
                    ctx.stroke();
                }

                if (isHinting && scHintMatch && ((scHintMatch[0].x===x && scHintMatch[0].y===y) || (scHintMatch[2].x===x && scHintMatch[2].y===y))) {
                    if (frameCount % 30 < 15) {
                        ctx.fillStyle = 'rgba(46, 204, 113, 0.5)';
                        drawRoundRect(ctx, 0, 0, tw, th, 8);
                        ctx.fill();
                    }
                }

                ctx.fillStyle = '#2c3e50';
                ctx.textAlign = "center"; ctx.textBaseline = "middle";
                drawTileText(t.text, tw/2, th/2);
                ctx.restore();
            }
        }

        if (scPath) {
            ctx.save();
            ctx.strokeStyle = '#f1c40f';
            ctx.lineWidth = 8;
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            ctx.shadowColor = '#e67e22'; ctx.shadowBlur = 15;
            
            ctx.beginPath();
            ctx.moveTo(scOffsetX + scPath[0].x*scTileSize + scTileSize/2, scOffsetY + scPath[0].y*scTileSize + scTileSize/2);
            for(var i=1; i<scPath.length; i++) {
                 ctx.lineTo(scOffsetX + scPath[i].x*scTileSize + scTileSize/2, scOffsetY + scPath[i].y*scTileSize + scTileSize/2);
            }
            ctx.stroke();
            
            ctx.strokeStyle = '#fff';
            ctx.lineWidth = 3;
            ctx.shadowBlur = 0;
            ctx.stroke();
            ctx.restore();
        }

        ctx.globalCompositeOperation = 'lighter'; 
        for(var part of shooterParticles) { 
            ctx.globalAlpha = part.life; 
            if (part.type === 'wave') {
                ctx.strokeStyle = part.color; ctx.lineWidth = 5 * part.life;
                ctx.beginPath(); ctx.arc(part.x, part.y, part.size + (1.0 - part.life) * 50, 0, Math.PI*2); ctx.stroke();
            } else {
                ctx.fillStyle = part.color; ctx.beginPath(); ctx.arc(part.x, part.y, part.size, 0, Math.PI*2); ctx.fill(); 
            }
        }
        ctx.globalCompositeOperation = 'source-over'; ctx.globalAlpha = 1.0;

        for(var ft of floatingTexts) { ctx.globalAlpha = ft.life; ctx.fillStyle = ft.color; ctx.font = "bold 40px Jua"; ctx.textAlign = "center"; ctx.shadowColor = "black"; ctx.shadowBlur = 5; ctx.fillText(ft.text, ft.x, ft.y); ctx.shadowBlur = 0; }
        ctx.globalAlpha = 1.0;

        drawLevelMessage();
    }

    function showLevelMsg() { Sound.levelUp(); showLevelMessageTimer = 50; }
    function drawLevelMessage() {
        if (showLevelMessageTimer > 0) {
            showLevelMessageTimer--;
            ctx.save();
            ctx.font = 'bold 40px Jua'; ctx.fillStyle = '#ffeb3b'; ctx.textAlign = 'center'; ctx.textBaseline = 'middle'; ctx.strokeStyle = 'black'; ctx.lineWidth = 4;
            var yPos = canvas.height * 0.2; 
            ctx.strokeText("âš¡ LEVEL UP! âš¡", canvas.width/2, yPos);
            ctx.fillText("âš¡ LEVEL UP! âš¡", canvas.width/2, yPos);
            ctx.restore();
        }
    }

    function showHint() { 
        if(isHinting) return; 
        if (currentGameMode === 'pipe') {
            isHinting = true; hintTimer = 60; 
        } else if (currentGameMode === 'sichuan') {
            var match = hasPossibleScMatch();
            if(match) {
                scHintMatch = match;
                isHinting = true;
                hintTimer = 90;
            } else {
                doScShuffle();
            }
        }
    }

    var lastTouchTime = 0;
    function handleInputStart(x, y) { 
        if (!gameRunning) return; 
        if (currentGameMode === 'sorting' || currentGameMode === 'shooter') { 
            var hitBuffer = 30; if (x >= player.x - hitBuffer && x <= player.x + player.size + hitBuffer && y >= player.y - hitBuffer && y <= player.y + player.size + hitBuffer) { isDragging = true; dragOffsetX = x - player.x; }
        } else if (currentGameMode === 'pipe') { 
            if (x >= pipeOffsetX && x < pipeOffsetX + gridCols*cellSize && y >= pipeOffsetY && y < pipeOffsetY + gridRows*cellSize) { 
                var gx = Math.floor((x - pipeOffsetX) / cellSize); var gy = Math.floor((y - pipeOffsetY) / cellSize); grid[gx][gy].rotation = (grid[gx][gy].rotation + 90) % 360; 
                Sound.click(); 
            } 
        } else if (currentGameMode === 'sichuan') {
            if(scPathTimer > 0) return; 
            
            var gx = Math.floor((x - scOffsetX) / scTileSize);
            var gy = Math.floor((y - scOffsetY) / scTileSize);
            
            if (gx >= 0 && gx < scCols && gy >= 0 && gy < scRows) {
                if (scGrid[gx][gy]) { 
                    Sound.click(); 
                    if (!scSelected) {
                        scSelected = {x:gx, y:gy};
                    } else {
                        if (scSelected.x === gx && scSelected.y === gy) {
                            scSelected = null; 
                        } else {
                            var path = checkScMatch(scSelected.x, scSelected.y, gx, gy);
                            if (path) {
                                scPath = path; 
                                scPathTimer = 15; 
                                scRemoving = [scSelected, {x:gx, y:gy}]; 
                                scSelected = null; 
                                isHinting = false; 
                                Sound.score(); 
                            } else {
                                scSelected = {x:gx, y:gy}; 
                            }
                        }
                    }
                }
            }
        }
    }
    function handleInputMove(x, y) {
        if (!gameRunning) return;
        if ((currentGameMode === 'sorting' || currentGameMode === 'shooter') && isDragging) {
            player.x = x - dragOffsetX; if (player.x < 0) player.x = 0; if (player.x > canvas.width - player.size) player.x = canvas.width - player.size;
        }
    }
    function stopInput() { isDragging = false; inputLeft = false; inputRight = false; }
    
    window.addEventListener('mousedown', function(e) { if (Date.now() - lastTouchTime < 500) return; handleInputStart(e.clientX, e.clientY); });
    window.addEventListener('mousemove', function(e) { handleInputMove(e.clientX, e.clientY); });
    window.addEventListener('mouseup', stopInput);
    window.addEventListener('touchstart', function(e) { if (!gameRunning) return; lastTouchTime = Date.now(); var t = e.touches[0]; handleInputStart(t.clientX, t.clientY); }, {passive: false});
    window.addEventListener('touchmove', function(e) { if (!gameRunning) return; e.preventDefault(); var t = e.touches[0]; handleInputMove(t.clientX, t.clientY); }, {passive: false});
    window.addEventListener('touchend', stopInput);
    window.addEventListener('keydown', function(e) { if(e.keyCode === 37) inputLeft = true; if(e.keyCode === 39) inputRight = true; });
    window.addEventListener('keyup', function(e) { if(e.keyCode === 37) inputLeft = false; if(e.keyCode === 39) inputRight = false; });

    function saveScore(newScore) { 
        var key = 'gimpoScores'; if (currentGameMode === 'pipe') key = 'gimpoPipeScores'; if (currentGameMode === 'shooter') key = 'gimpoShooterScores'; if (currentGameMode === 'sichuan') key = 'gimpoSichuanScores';
        var scores = JSON.parse(safeGetItem(key) || "[]"); var dateStr = new Date().toLocaleDateString(); 
        scores.push({ score: newScore, date: dateStr, level: currentLevel }); scores.sort(function(a, b) { return b.score - a.score; }); scores = scores.slice(0, 10); safeSetItem(key, JSON.stringify(scores)); 
    }
    function showRanking() { 
        var key = 'gimpoScores'; if (currentGameMode === 'pipe') key = 'gimpoPipeScores'; if (currentGameMode === 'shooter') key = 'gimpoShooterScores'; if (currentGameMode === 'sichuan') key = 'gimpoSichuanScores';
        var scores = JSON.parse(safeGetItem(key) || "[]"); var html = ""; 
        if (scores.length === 0) html = "<div style='text-align:center; padding:10px;'>ê¸°ë¡ ì—†ìŒ</div>"; 
        else { 
            var len = Math.min(scores.length, 3);
            for (var i = 0; i < len; i++) { 
                var text = scores[i].score + "ì "; if ((currentGameMode === 'pipe' || currentGameMode === 'sichuan') && scores[i].level) text = "Lv." + scores[i].level + " (" + scores[i].score + ")"; html += "<div class='rank-item'><span>" + (i+1) + "ìœ„</span><span>" + text + "</span></div>"; 
            } 
        } 
        rankBoard.innerHTML = html; 
    }
    
    function showRandomEcoQuote() {
        var qArea = document.getElementById('eco-quote');
        if(qArea) {
            var randomQuote = CONFIG.ecoQuotes[Math.floor(Math.random() * CONFIG.ecoQuotes.length)];
            qArea.innerHTML = randomQuote;
        }
    }

    function gameClear() { 
        document.getElementById('ingame-home-btn').style.display = 'none'; 
        gameRunning = false; score += 10000; saveScore(score); showRanking(); showRandomEcoQuote();
        uiLayer.style.display = 'flex'; uiLayer.style.background = 'rgba(0,0,0,0.95)'; 
        gameTitle.innerText = "ğŸ† ëª…ì˜ˆì˜ ì „ë‹¹ ë“±ê·¹! ğŸ†"; 
        gameGuide.innerHTML = "<span style='color:#f1c40f; font-size:28px; font-weight:bold;'>ì¶•í•˜í•©ë‹ˆë‹¤!</span><br>ëª¨ë“  ë ˆë²¨(38)ì„ í´ë¦¬ì–´í–ˆìŠµë‹ˆë‹¤!<br>ìµœì¢… ì ìˆ˜: " + score; 
        rankArea.style.display = 'flex'; startBtnArea.style.display = 'none'; gameoverBtnArea.style.display = 'block'; 
    }

    function gameOver(reason1, reason2) { 
        document.getElementById('ingame-home-btn').style.display = 'none';
        Sound.error(); 
        gameRunning = false; if(currentGameMode === 'pipe' || currentGameMode === 'sichuan') score += (currentLevel - 1) * 1000; 
        saveScore(score); showRanking(); showRandomEcoQuote();
        uiLayer.style.display = 'flex'; uiLayer.style.background = 'rgba(0,0,0,0.95)'; 
        var titleText = "ê²Œì„ ì˜¤ë²„"; if(currentGameMode === 'sorting') titleText = "í˜¼ì… ì ë°œ!"; else if(currentGameMode === 'pipe') titleText = "ì˜¨ìˆ˜ ê³µê¸‰ ì‹¤íŒ¨"; else if(currentGameMode === 'shooter') titleText = "í™˜ê²½ ì˜¤ì—¼ ë°œìƒ"; else if(currentGameMode === 'sichuan') titleText = "ì •í™” ì‹œê°„ ì´ˆê³¼";
        gameTitle.innerText = "ğŸš¨ " + titleText; 
        gameGuide.innerHTML = "<span style='color:#ff4444; font-size:24px; font-weight:bold;'>[" + reason1 + " " + reason2 + "]</span><br><br>ìµœì¢… ì ìˆ˜: " + score; 
        rankArea.style.display = 'flex'; startBtnArea.style.display = 'none'; gameoverBtnArea.style.display = 'block'; 
    }
</script>
    // [ì¶”ê°€] ì‹¤í–‰ ì‹œ ìºì‹œë¥¼ ë¹„ì›Œ ìƒˆë¡œìš´ ë²„ì „ì„ ê°•ì œë¡œ ê°€ì ¸ì˜¤ê²Œ í•¨
if ('serviceWorker' in navigator) {
    // 1. ê¸°ì¡´ íŒŒì¼ ìºì‹œ ì‚­ì œ (ì¹´ìš´í„° ë°ì´í„°ëŠ” ìœ ì§€ë¨)
    caches.keys().then(cacheNames => {
        cacheNames.forEach(cacheName => {
            if (cacheName !== 'gimpo-center-v1') { // í˜„ì¬ ë²„ì „ì´ ì•„ë‹ˆë©´ ì‚­ì œ
                caches.delete(cacheName);
            }
        });
    });
    
    // 2. ì„œë¹„ìŠ¤ ì›Œì»¤ê°€ ì—…ë°ì´íŠ¸ê°€ ìˆëŠ”ì§€ ì²´í¬
    navigator.serviceWorker.ready.then(registration => {
        registration.update();
    });
}
</body>

</html>



